<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Sign Wars | Organisers</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Sign Wars" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="CTF Team" />
<meta property="og:description" content="CTF Team" />
<link rel="canonical" href="https://org.anize.rs/SECCON-2021/crypto/signwars.html" />
<meta property="og:url" content="https://org.anize.rs/SECCON-2021/crypto/signwars.html" />
<meta property="og:site_name" content="Organisers" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Sign Wars" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"CTF Team","headline":"Sign Wars","url":"https://org.anize.rs/SECCON-2021/crypto/signwars.html"}</script>
<!-- End Jekyll SEO tag -->


    <meta property="og:image" content="https://org.anize.rs/assets/images/logo.png" />
    <meta name="twitter:card" content="summary" />
    <!-- TODO <meta name="twitter:description" content="" /> -->
    <meta name="twitter:title" content="Organisers" />
    <meta name="twitter:site" content="@0rganizers" />
    <!-- TODO <meta name="twitter:image" content="" /> -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#040d21">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Hack monospace font -->
    <link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>
    <link rel="stylesheet" href="/assets/css/style.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">
    <link rel="stylesheet" href="/assets/css/highlight.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">
    <link rel="stylesheet" href="/assets/css/light.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">

    <!-- legitimize current Mastodon profile via link verification -->
    <link rel="me" href="https://infosec.exchange/@organizers" />


    <script type="text/javascript">
        function isLightThemeSelected() {
          return document.cookie.match(/theme=light/i) != null
        }

        function setThemeFromCookie() {
            var html = document.getElementsByTagName('html')[0]
            html.className = isLightThemeSelected() ? 'light-theme' : 'dark-theme'
            console.log('Loaded cookie: ' + document.cookie)
        }

        (function() {
          setThemeFromCookie()
        })();
    </script>

    <script type="text/javascript">
        function getFootnoteContent(linkId) {
            const fnId = linkId.replace(/^fnref/, 'fn');
            return document.getElementById(fnId).querySelector("p").innerHTML;
        }

        function addFootnote(element, content) {
            const footnote = document.createElement('div');
            footnote.classList.add('footnote-box');
            // Also add the footnote number
            footnote.innerHTML = `<sup>${element.innerText}</sup> ${content}`;
            footnote.querySelectorAll('a.reversefootnote').forEach((backlink) => {
                footnote.removeChild(backlink);
            });
            element.insertAdjacentElement('afterend', footnote);
            element.dataset.toggled = '1';
        }

        function removeFootnote(element) {
            element.parentElement.removeChild(element.nextSibling);
            element.dataset.toggled = '0';
        }


        window.addEventListener("load", function() {
            document.querySelectorAll("a.footnote").forEach((el) => {
                const sup = el.parentElement;
                el.addEventListener("click", (event) => {
                    const isOpen = Number.parseInt(sup.dataset.toggled || '0');
                    if (!isOpen) {
                        addFootnote(sup, getFootnoteContent(sup.id));
                    } else {
                        removeFootnote(sup);
                    }
                    event.preventDefault();
                });
            });
        });
    </script>

    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      "HTML-CSS": {
        fonts: ["Gyre-Pagella"],
        imageFont: null,
        undefinedFamily: "'Arial Unicode MS', cmbright"
      },
      tex2jax: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        processEscapes: true
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS_HTML"></script>
  </head>
  
  <body> 
    <header class="page-header-simple" role="banner">
      
      <div class="left-links"><a id="header-logo" href="/">Organi{s|z}ers</a></div>
      <div class="right-links">
        <a href="/writeups">Writeups</a>
        <a href="/achievements">Achievements</a>
      </div>
    </header>

    <main id="content" class="main-content" role="main">
      <h1 id="sign-wars">Sign Wars</h1>

<p><strong>Author</strong>: Robin_Jadoul, solved together with <a href="https://twitter.com/esrever_25519">esrever</a></p>

<p><strong>Tags</strong>: crypto, ecdsa, lattice, mt19937</p>

<p><strong>Points</strong>: 305 (8 solves)</p>

<h2 id="the-challenge">The challenge</h2>

<blockquote>
  <p>A long time ago in a galaxy far, far away….</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">long_to_bytes</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">msg1</span><span class="p">,</span> <span class="n">msg2</span><span class="p">,</span> <span class="n">flag</span>

<span class="n">flag</span> <span class="o">=</span> <span class="n">pad</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="mi">96</span><span class="p">)</span>
<span class="n">flag1</span> <span class="o">=</span> <span class="n">flag</span><span class="p">[:</span><span class="mi">48</span><span class="p">]</span>
<span class="n">flag2</span> <span class="o">=</span> <span class="n">flag</span><span class="p">[</span><span class="mi">48</span><span class="p">:]</span>

<span class="c1"># P-384 Curve
</span><span class="n">p</span> <span class="o">=</span> <span class="mi">39402006196394479212279040100143613805079739270465446667948293404245721771496870329047266088258938001861606973112319</span>
<span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">27580193559959705877849011840389048093056905856361568521428707301988689241309860865136260764883745107765439761230575</span>
<span class="n">curve</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
<span class="n">order</span> <span class="o">=</span> <span class="mi">39402006196394479212279040100143613805079739270465446667946905279627659399113263569398956308152294913554433653942643</span>
<span class="n">Z_n</span> <span class="o">=</span> <span class="n">GF</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<span class="n">gx</span> <span class="o">=</span> <span class="mi">26247035095799689268623156744566981891852923491109213387815615900925518854738050089022388053975719786650872476732087</span>
<span class="n">gy</span> <span class="o">=</span> <span class="mi">8325710961489029985546751289520108179287853048861315594709205902480503199884419224438643760392947333078086511627871</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">curve</span><span class="p">(</span><span class="n">gx</span><span class="p">,</span> <span class="n">gy</span><span class="p">)</span>

<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">msg1</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">b</span> <span class="o">&gt;=</span> <span class="mh">0x20</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="mh">0x7f</span>
<span class="n">z1</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">msg1</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">z1</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">^</span><span class="mi">128</span>

<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">msg2</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">b</span> <span class="o">&gt;=</span> <span class="mh">0x20</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="mh">0x7f</span>
<span class="n">z2</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">msg2</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">z2</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">^</span><span class="mi">384</span>

<span class="c1"># prequel trilogy
</span><span class="k">def</span> <span class="nf">sign_prequel</span><span class="p">():</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">flag1</span><span class="p">)</span>
    <span class="n">sigs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">80</span><span class="p">):</span>
        <span class="c1"># normal ECDSA. all bits of k are unknown.
</span>        <span class="n">k1</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
        <span class="n">k2</span> <span class="o">=</span> <span class="n">z1</span>
        <span class="n">k3</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">k3</span> <span class="o">&lt;&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">k2</span> <span class="o">&lt;&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">+</span> <span class="n">k1</span>
        <span class="n">kG</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">G</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">kG</span><span class="p">.</span><span class="n">xy</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Z_n</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">Z_n</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">z1</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">k</span>
        <span class="n">sigs</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">sigs</span>

<span class="c1"># original trilogy
</span><span class="k">def</span> <span class="nf">sign_original</span><span class="p">():</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">flag2</span><span class="p">)</span>
    <span class="n">sigs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="c1"># normal ECDSA
</span>        <span class="n">k</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">384</span><span class="p">)</span>
        <span class="n">kG</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">G</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">kG</span><span class="p">.</span><span class="n">xy</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Z_n</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">Z_n</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">z2</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">k</span>
        <span class="n">sigs</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">sigs</span>


<span class="k">def</span> <span class="nf">sign</span><span class="p">():</span>
    <span class="n">sigs1</span> <span class="o">=</span> <span class="n">sign_prequel</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sigs1</span><span class="p">)</span>
    <span class="n">sigs2</span> <span class="o">=</span> <span class="n">sign_original</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sigs2</span><span class="p">)</span>
    

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">sign</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="preliminary-analysis">Preliminary analysis</h2>

<p>We observe that the flag is cut into two separate pieces, and we get some ECDSA signatures (over the P-384 curve) for two separate (ascii-range) messages where each part of the flag is used as a secret key respectively. We however do not learn either of the messages being signed.
For the first part of the flag, we get 80 signatures, where the message being signed is embedded into the random nonce as $k = k_3\cdot 2^{256} + z_1 \cdot 2^{128} + k_1$ where each of $k_1, k_3, z_1$ consists of 128 bits. Having a bias to an (EC)DSA signature nonce, along with a fair amount of signatures quickly points towards a lattice attack exploiting the bias, similar to e.g. <a href="https://eprint.iacr.org/2019/023.pdf">this paper</a>, through a reduction to the Hidden Number Problem.
For the second part, we only get 3 signatures, and the nonce bias has disappeared. So it seems we can’t apply the same approach here anymore. The only way we can attack this (even solving the discrete logarithm won’t help us here, as we can’t recover a public key without knowing the message either), is by knowing exactly what randomness we’re dealing with. Luckily for us, the challenge is using <code class="language-plaintext highlighter-rouge">random.getrandbits</code>, which is using a Mersenne twister behind the scenes, and given enough outputs of a Mersenne twister, we can predict other outputs. Where can we get such known outputs, you ask? Well we have some $80 \times 256$ bits of randomness we can recover from the signatures in part one if we manage to recover both the private key and the message being signed there.</p>

<h2 id="whats-a-ctf-crypto-challenge-without-lattices">What’s a CTF crypto challenge without lattices?</h2>

<p>The straightforward transformation from ECDSA to HNP generally assumes we know the value of the fixed bits. This is, given that we don’t know the message being signed yet, not the case here, so we’ll need to massage our signatures a bit first.
Our goal will be to “sacrifice” one of our signatures to subtract away the $z_1$ in the other nonces and arrive at a known bias of 0 for the remaining 79 signatures. With some rewriting, we obtain the following:
\begin{align*}
     &amp;&amp;s^{(j)} \cdot k^{(j)} &amp;= z_1 + r^{(j)}\cdot d + m^{(j)} \cdot |G| \newline
\iff &amp;&amp;(s^{(j)} \cdot 2^{128} - 1) \cdot z_1 &amp;= -s^{(j)} \cdot (k_3^{(j)}\cdot 2^{256} + k_1^{(j)}) + r^{(j)}\cdot d + m^{(j)}\cdot |G|
\end{align*}
And by rewriting an arbitrary fixed signature (say the very first one) into an equivalent form, equating $z_1 = z_1$ and doing a cross multiplication, we get
\begin{align*}
    &amp;&amp;(s^{(j)}\cdot 2^{128} - 1) \cdot \left(-s^{(j)} \cdot (k_3^{(j)}\cdot 2^{256} + k_1^{(j)}) + r^{(j)}\cdot d + m^{(j)}\cdot |G|\right)\newline
    &amp;= \newline
    &amp;&amp;(s^{(0)}\cdot 2^{128} - 1) \cdot \left(-s^{(0)} \cdot (k_3^{(0)}\cdot 2^{256} + k_1^{(0)}) + r^{(0)}\cdot d + m^{(0)}\cdot |G|\right)
\end{align*}</p>

<p>From this set of linear constraints, along with the known (or easy-to-derive) bounds on each of the unknown variables, we can then apply some <a href="https://github.com/rkm0959/Inequality_Solving_with_CVP/">black magic</a><sup id="fnref:rkm" role="doc-noteref"><a href="#fn:rkm" class="footnote" rel="footnote">1</a></sup> and obtain the secret key (which is the first half of the flag), and some of the $k_1^{(j)}$ and $k_3^{(j)}$ we care about for the next part of the challenge at once.</p>

<h3 id="some-lattice-code">Some lattice code</h3>

<p>With the theoretical part out of the way, we first just setup our wrapper around rkm’s work that allows us to simply specify our linear (in)equalities and to automatically get the lattice out of it.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Mapping</span>


<span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">Constraint</span><span class="p">:</span>
    <span class="s">""" Constraint on a linear function
    The corresponding formula is:
        lower_bound &lt;= sum(coefficients[var] * var, for all var) &lt;= upper_bound
    """</span>
    <span class="n">coefficients</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="n">lower_bound</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">upper_bound</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s">' + '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s">*</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s">'</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">coefficients</span><span class="p">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">lower_bound</span><span class="si">}</span><span class="s"> &lt;= </span><span class="si">{</span><span class="n">formula</span><span class="si">}</span><span class="s"> &lt;= </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">upper_bound</span><span class="si">}</span><span class="s">'</span>


<span class="k">def</span> <span class="nf">constraints_to_lattice</span><span class="p">(</span>
    <span class="n">constraints</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Constraint</span><span class="p">],</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'constraints = ['</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">',</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="se">\t</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s">'</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">']'</span><span class="p">)</span>

    <span class="n">variables</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="p">.</span><span class="n">from_iterable</span><span class="p">(</span>
        <span class="n">c</span><span class="p">.</span><span class="n">coefficients</span><span class="p">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span>
    <span class="p">))))</span>

    <span class="n">lattice</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">constraints</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">coef</span> <span class="ow">in</span> <span class="n">c</span><span class="p">.</span><span class="n">coefficients</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">lattice</span><span class="p">[</span><span class="n">variables</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="n">var</span><span class="p">)][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">coef</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'variables = </span><span class="si">{</span><span class="n">variables</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'lattice_nrows = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span><span class="si">}</span><span class="s"> variables'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'lattice_ncols = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span><span class="si">}</span><span class="s"> constraints'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'lattice ='</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">lattice</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">'*'</span> <span class="k">if</span> <span class="n">v</span> <span class="k">else</span> <span class="s">'.'</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">variables</span>


<span class="c1"># ===== rkm solver =====
</span>

<span class="k">def</span> <span class="nf">load_rkm_solver</span><span class="p">(</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
    <span class="s">""" Load rkm's solver without overwriting solve() in globals() """</span>
    <span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">'https://raw.githubusercontent.com/rkm0959/Inequality_Solving_with_CVP/main/solver.sage'</span>  <span class="c1"># noqa
</span>    <span class="n">context</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="nb">globals</span><span class="p">())</span>
    <span class="n">sage</span><span class="p">.</span><span class="n">repl</span><span class="p">.</span><span class="n">load</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">context</span><span class="p">[</span><span class="s">'solve'</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">rkm_wrapper</span><span class="p">(</span>
    <span class="n">constraints</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Constraint</span><span class="p">],</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">solver</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">load_rkm_solver</span><span class="p">(),</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="s">""" Wrapper for rkm's inequalities solver """</span>
    <span class="n">lattice</span><span class="p">,</span> <span class="n">variables</span> <span class="o">=</span> <span class="n">constraints_to_lattice</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>

    <span class="c1"># Call solver
</span>    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Start solving...'</span><span class="p">)</span>
    <span class="n">weighted_close_vec</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">sol_vec</span> <span class="o">=</span> \
        <span class="n">solver</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">lattice</span><span class="p">),</span>
               <span class="p">[</span><span class="n">c</span><span class="p">.</span><span class="n">lower_bound</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">],</span>
               <span class="p">[</span><span class="n">c</span><span class="p">.</span><span class="n">upper_bound</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">],</span>
               <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Get solution
</span>    <span class="k">if</span> <span class="n">sol_vec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">weighted_lattice</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">lattice</span><span class="p">)</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">H</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">weighted_lattice</span><span class="p">.</span><span class="n">hermite_form</span><span class="p">(</span><span class="n">transformation</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">sol_vec</span> <span class="o">=</span> <span class="n">H</span><span class="p">.</span><span class="n">solve_left</span><span class="p">(</span><span class="n">weighted_close_vec</span><span class="p">).</span><span class="n">change_ring</span><span class="p">(</span><span class="n">ZZ</span><span class="p">)</span> <span class="o">*</span> <span class="n">U</span>
    <span class="n">solution</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">sol_vec</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'solution = </span><span class="si">{</span><span class="n">solution</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

    <span class="c1"># Check solution
</span>    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
        <span class="n">coefs</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">coefficients</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">upper_bound</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coef</span> <span class="o">*</span> <span class="n">solution</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">coef</span> <span class="ow">in</span> <span class="n">coefs</span><span class="p">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lb</span> <span class="o">&lt;=</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="n">ub</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Constrained value out-of-bound, '</span>
                            <span class="sa">f</span><span class="s">'lb=</span><span class="si">{</span><span class="n">lb</span><span class="si">}</span><span class="s">, ub=</span><span class="si">{</span><span class="n">ub</span><span class="si">}</span><span class="s">, value=</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s">, coefs=</span><span class="si">{</span><span class="n">coefs</span><span class="si">}</span><span class="s">, '</span>
                            <span class="sa">f</span><span class="s">'solution=</span><span class="si">{</span><span class="n">solution</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">solution</span>
</code></pre></div></div>

<p>After which we encode the constraints, and get a stimulating first half of the flag.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sigs</span> <span class="o">=</span> <span class="p">...</span> <span class="c1"># challenge data
</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>

<span class="c1"># Constants
</span><span class="n">order</span> <span class="o">=</span> <span class="mi">39402006196394479212279040100143613805079739270465446667946905279627659399113263569398956308152294913554433653942643</span>


<span class="c1"># STEP: solve d
</span>
<span class="c1"># Variables
</span><span class="n">n_samples</span> <span class="o">=</span> <span class="mi">7</span>

<span class="n">d_var</span> <span class="o">=</span> <span class="s">'d'</span>
<span class="n">k1s</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s">'k1_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">'</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)]</span>
<span class="n">k3s</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s">'k3_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">'</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)]</span>
<span class="n">ms</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s">'m_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">'</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)]</span>

<span class="c1"># Constraints
</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Size: 0 &lt;= d &lt; 2**384
</span><span class="n">constraints</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">Constraint</span><span class="p">({</span><span class="n">d_var</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">384</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="c1"># Size: 0 &lt;= k1s[i], k3s[i] &lt; 2**128
</span><span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">k1s</span> <span class="o">+</span> <span class="n">k3s</span><span class="p">:</span>
    <span class="n">constraints</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">Constraint</span><span class="p">({</span><span class="n">var</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">128</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

<span class="c1"># ss[i] * (k3s[i] || z1 || k1s[i]) = z1 + rs[i]*d + m[i]*order
# =&gt; z1 = (-ss[i]*k3s[i]*2**256 - ss[i]*k1s[i] + rs[i]*d + m[i]*order) / (ss[i]*2**128 - 1)
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">):</span>
    <span class="n">r0</span><span class="p">,</span> <span class="n">s0</span> <span class="o">=</span> <span class="n">sigs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ri</span><span class="p">,</span> <span class="n">si</span> <span class="o">=</span> <span class="n">sigs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">cz0</span> <span class="o">=</span> <span class="n">s0</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="mi">128</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">czi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">si</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="mi">128</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">coefs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">d_var</span><span class="p">:</span> <span class="n">ri</span><span class="o">*</span><span class="n">cz0</span> <span class="o">+</span> <span class="n">r0</span><span class="o">*</span><span class="n">czi</span><span class="p">,</span>
        <span class="n">k1s</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">cz0</span> <span class="o">*</span> <span class="o">-</span><span class="n">si</span><span class="p">,</span>
        <span class="n">k3s</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">cz0</span> <span class="o">*</span> <span class="o">-</span><span class="n">si</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="mi">256</span><span class="p">,</span>
        <span class="n">ms</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">order</span> <span class="o">*</span> <span class="n">cz0</span><span class="p">,</span>
        <span class="n">k1s</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">czi</span> <span class="o">*</span> <span class="o">-</span><span class="n">s0</span><span class="p">,</span>
        <span class="n">k3s</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">czi</span> <span class="o">*</span> <span class="o">-</span><span class="n">s0</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="mi">256</span><span class="p">,</span>
        <span class="n">ms</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">order</span> <span class="o">*</span> <span class="n">czi</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">constraints</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">Constraint</span><span class="p">(</span><span class="n">coefs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

<span class="c1"># Solve
</span><span class="n">solution</span> <span class="o">=</span> <span class="n">rkm_wrapper</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">solution</span><span class="p">[</span><span class="n">d_var</span><span class="p">]</span> <span class="o">%</span> <span class="n">order</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'d = </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s"> = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">).</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="s">"big"</span><span class="p">)</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
</code></pre></div></div>
<blockquote>
  <p>SECCON{New_STARWARS_Spin-Off_The_Book_Of_Boba_Fe</p>
</blockquote>

<p><em>Quick note:</em> It’s very likely possible and even simple to forgo the sacrifice for $z_1$ and just directly add it as a constraint in our lattice solver. This is just the way we went about it before deciding to just pick up that hammer instead of setting up a clean lattice specifically for the resulting HNP.</p>

<h2 id="dancing-a-twist">Dancing a twist</h2>

<p>From here, we can either recover $z_1$ first, so we can extract the randomness from the signatures, or just use all signatures rather than only 7 of them to let the lattice do all the work.
We chose to go with the former:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_z1_num</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">k3</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">s</span><span class="o">*</span><span class="n">k3</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="mi">256</span> <span class="o">-</span> <span class="n">s</span><span class="o">*</span><span class="n">k1</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="n">d</span> <span class="o">+</span> <span class="n">m</span><span class="o">*</span><span class="n">order</span>
<span class="k">def</span> <span class="nf">get_z1_denom</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="mi">128</span> <span class="o">-</span> <span class="mi">1</span>
<span class="k">def</span> <span class="nf">get_z1</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">k3</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">get_z1_num</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">k3</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="n">get_z1_denom</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">num</span> <span class="o">%</span> <span class="n">denom</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">num</span> <span class="o">//</span> <span class="n">denom</span>
<span class="n">z1s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
    <span class="n">z1s</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_z1</span><span class="p">(</span><span class="n">sigs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">solution</span><span class="p">[</span><span class="n">k3s</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">solution</span><span class="p">[</span><span class="n">k1s</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sigs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">solution</span><span class="p">[</span><span class="n">d_var</span><span class="p">],</span> <span class="n">solution</span><span class="p">[</span><span class="n">ms</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
<span class="k">assert</span> <span class="n">z1s</span> <span class="o">==</span> <span class="p">[</span><span class="n">z1s</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">z1s</span><span class="p">),</span> <span class="s">'z1 not all equal'</span>
<span class="n">z1</span> <span class="o">=</span> <span class="n">z1s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">order</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'z1 = </span><span class="si">{</span><span class="n">z1</span><span class="si">}</span><span class="s"> = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">z1</span><span class="p">).</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s">"big"</span><span class="p">)</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
</code></pre></div></div>
<p>immediately already recovered all randomness that came from the Mersenne Twister during part 1, and hence we should have plenty of data to recover the full nonces of part 2. We simply dig through old CTF files lying around in our home directory (because who would ever think of cleanly organizing any of this…) and dig up our z3-based solver.
<em>Yes, it’s easy enough to do it without SMT solving, but having these kinds of hammers lying around is always so much more inviting.</em></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">MT19937</span><span class="p">:</span>
    <span class="n">W</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">624</span>
    <span class="n">M</span> <span class="o">=</span> <span class="mi">397</span>
    <span class="n">R</span> <span class="o">=</span> <span class="mi">31</span>
    <span class="n">A</span> <span class="o">=</span> <span class="mh">0x9908B0DF</span>
    <span class="n">U</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">D</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span>
    <span class="n">S</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">B</span> <span class="o">=</span> <span class="mh">0x9D2C5680</span>
    <span class="n">T</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">C</span> <span class="o">=</span> <span class="mh">0xEFC60000</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mi">18</span>

    <span class="n">F</span> <span class="o">=</span> <span class="mi">1812433253</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">urandom</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">W</span> <span class="o">//</span> <span class="mi">8</span><span class="p">),</span> <span class="n">byteorder</span><span class="o">=</span><span class="s">'little'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">[</span><span class="n">seed</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="p">.</span><span class="n">W</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">N</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="n">F</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">W</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="p">.</span><span class="n">W</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">N</span>

    <span class="k">def</span> <span class="nf">rand</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="p">.</span><span class="n">N</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_twist</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">^=</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">U</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">.</span><span class="n">D</span>
        <span class="n">y</span> <span class="o">^=</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">S</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">.</span><span class="n">B</span>
        <span class="n">y</span> <span class="o">^=</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">T</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">.</span><span class="n">C</span>
        <span class="n">y</span> <span class="o">^=</span> <span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">L</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">y</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="p">.</span><span class="n">W</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rand128</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">rand</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">32</span><span class="p">))</span> <span class="o">|</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_twist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lower_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">R</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">upper_mask</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">lower_mask</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="p">.</span><span class="n">W</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">upper_mask</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="p">.</span><span class="n">N</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">lower_mask</span><span class="p">)</span>
            <span class="n">xA</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">xA</span> <span class="o">^=</span> <span class="bp">self</span><span class="p">.</span><span class="n">A</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">M</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="p">.</span><span class="n">N</span><span class="p">]</span> <span class="o">^</span> <span class="n">xA</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">class</span> <span class="nc">Z3MT19937</span><span class="p">:</span>
    <span class="n">W</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">624</span>
    <span class="n">M</span> <span class="o">=</span> <span class="mi">397</span>
    <span class="n">R</span> <span class="o">=</span> <span class="mi">31</span>
    <span class="n">A</span> <span class="o">=</span> <span class="mh">0x9908B0DF</span>
    <span class="n">U</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">D</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span>
    <span class="n">S</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">B</span> <span class="o">=</span> <span class="mh">0x9D2C5680</span>
    <span class="n">T</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">C</span> <span class="o">=</span> <span class="mh">0xEFC60000</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mi">18</span>

    <span class="n">F</span> <span class="o">=</span> <span class="mi">1812433253</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">[</span><span class="n">BitVec</span><span class="p">(</span><span class="sa">f</span><span class="s">"state_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">"</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">N</span><span class="p">)]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">N</span>

    <span class="k">def</span> <span class="nf">rand</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="p">.</span><span class="n">N</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_twist</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">^=</span> <span class="n">LShR</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">U</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">.</span><span class="n">D</span>
        <span class="n">y</span> <span class="o">^=</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">S</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">.</span><span class="n">B</span>
        <span class="n">y</span> <span class="o">^=</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">T</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">.</span><span class="n">C</span>
        <span class="n">y</span> <span class="o">^=</span> <span class="n">LShR</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">L</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">y</span>
    
    <span class="k">def</span> <span class="nf">rand128</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">rand</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">Concat</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">rand</span><span class="p">(),</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">128</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_twist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lower_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">R</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">upper_mask</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">lower_mask</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="p">.</span><span class="n">W</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">upper_mask</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="p">.</span><span class="n">N</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">lower_mask</span><span class="p">)</span>
            <span class="n">xA</span> <span class="o">=</span> <span class="n">LShR</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">xA</span> <span class="o">=</span> <span class="n">If</span><span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">xA</span> <span class="o">^</span> <span class="bp">self</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">xA</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">M</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="p">.</span><span class="n">N</span><span class="p">]</span> <span class="o">^</span> <span class="n">xA</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">crack</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">fr</span> <span class="o">=</span> <span class="n">Z3MT19937</span><span class="p">()</span>
    <span class="n">initstate</span> <span class="o">=</span> <span class="n">fr</span><span class="p">.</span><span class="n">state</span><span class="p">[:]</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offset</span><span class="p">):</span>
        <span class="n">fr</span><span class="p">.</span><span class="n">rand128</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="n">s</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">inp</span> <span class="o">==</span> <span class="n">fr</span><span class="p">.</span><span class="n">rand128</span><span class="p">())</span>
    <span class="n">s</span><span class="p">.</span><span class="n">check</span><span class="p">()</span>
    <span class="n">dup</span> <span class="o">=</span> <span class="n">MT19937</span><span class="p">()</span>
    <span class="n">dup</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">model</span><span class="p">()[</span><span class="n">x</span><span class="p">].</span><span class="n">as_long</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">initstate</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'state.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dup</span><span class="p">.</span><span class="n">state</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="n">dup</span><span class="p">.</span><span class="n">rand128</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offset</span><span class="p">):</span>
        <span class="n">dup</span><span class="p">.</span><span class="n">rand128</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">dup</span>

<span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sigs</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">z1</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">s</span> <span class="o">%</span> <span class="n">order</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">**</span><span class="mi">128</span> <span class="o">==</span> <span class="n">z1</span><span class="p">,</span> <span class="sa">f</span><span class="s">'bad k, i = </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">'</span>
    <span class="n">blocks</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span> <span class="o">%</span> <span class="mi">2</span><span class="o">**</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">blocks</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span> <span class="o">&gt;&gt;</span> <span class="mi">256</span><span class="p">)</span>

<span class="n">rnd</span> <span class="o">=</span> <span class="n">crack</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>
<span class="n">ks</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">^</span><span class="mi">128</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">^</span><span class="mi">256</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[[</span><span class="n">rnd</span><span class="p">.</span><span class="n">rand128</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]]]</span>
</code></pre></div></div>

<p>From there, the only obstacle left is that we’re once again unaware of the value taken by $z_2$. So we repeat our approach of combining two signatures to cancel it out, and solve for the private key.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">sigs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">sigs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">%</span> <span class="n">order</span>
<span class="k">print</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">).</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="s">'big'</span><span class="p">))</span>
<span class="n">z2</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">sigs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span> <span class="o">%</span> <span class="n">order</span>
<span class="k">print</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">z2</span><span class="p">).</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="s">'big'</span><span class="p">).</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s">'</span><span class="se">\0</span><span class="s">'</span><span class="p">))</span>
</code></pre></div></div>

<h2 id="fin">Fin</h2>
<p>And there we go, just apply the right hammers and you can smash a CTF challenge into tiny bits.
The full flag:</p>
<blockquote>
  <p>SECCON{New_STARWARS_Spin-Off_The_Book_Of_Boba_Fett_Will_Premiere_On_December_29-107c360aab}</p>
</blockquote>

<p>And just for fun, the messages being signed:</p>

<blockquote>
  <p>th1s_1s_n0t_fl4g</p>
</blockquote>

<blockquote>
  <p>May_The_Lattice_Reduction_Be_With_You…</p>
</blockquote>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:rkm" role="doc-endnote">
      <p>Thanks again, rkm! <a href="#fnref:rkm" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>




<!--       <footer class="site-footer">
        <a href="https://twitter.com/0rganizers">Twitter</a> | <a id="changeTheme" class="btn-toggle">Dark-Mode</a>
      </footer> -->

      <div class="lever-meme">
        <div id="lever" class="lever-off"></div>
      </div>

      <div class="twitter">
        <a href="https://twitter.com/0rganizers"><img src="/assets/images/twitter.svg"></a>
      </div>

      <script>
        let leverCount = 0;
        let manic = false;

        function resetLever() {
            leverCount = 0;
            setTimeout(resetLever, 1750);
        }

        resetLever();

        document.getElementById('lever')
        .addEventListener('click', function (event) {
          if(leverCount > 10){
            manic = true;
            document.getElementById("lever").classList.add('lever-manic');
            document.getElementById("header-logo").classList.add('rainbow');
          }

          if(!manic){
            document.getElementById("lever").classList.toggle('lever-on');
            ++leverCount;
          }
        });


      </script>

      <script>
      function updateThemeToggleFooter() {
        let elem = document.querySelector('#lever');
        // elem.innerHTML = isLightThemeSelected() ? 'Dark Mode' : 'Light Mode'
      }

      (function() {
        updateThemeToggleFooter()
      })();

      function togglePageContentLightDark() {
          var html = document.getElementsByTagName('html')[0]
          var currentClass = html.className
          var newClass = html.className == 'dark-theme' ? 'light-theme' : 'dark-theme'
          html.className = newClass

          document.cookie = 'theme=' + (newClass == 'light-theme' ? 'light' : 'dark') + '; SameSite=Strict; path=/; expires=Fri, 31 Dec 9999 23:59:59 GMT'
          console.log('Cookies are now: ' + document.cookie)

          updateThemeToggleFooter()
      }

      const btn = document.querySelector("#lever");
      btn.addEventListener("click", function() {
        togglePageContentLightDark();
      });
      </script>
    </main>
  </body>
</html>
