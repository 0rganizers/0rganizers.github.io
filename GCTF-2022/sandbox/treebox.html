<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Treebox | Organisers</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Treebox" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="CTF Team" />
<meta property="og:description" content="CTF Team" />
<link rel="canonical" href="https://org.anize.rs/GCTF-2022/sandbox/treebox.html" />
<meta property="og:url" content="https://org.anize.rs/GCTF-2022/sandbox/treebox.html" />
<meta property="og:site_name" content="Organisers" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Treebox" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"CTF Team","headline":"Treebox","url":"https://org.anize.rs/GCTF-2022/sandbox/treebox.html"}</script>
<!-- End Jekyll SEO tag -->


    <meta property="og:image" content="https://org.anize.rs/assets/images/logo.png" />
    <meta name="twitter:card" content="summary" />
    <!-- TODO <meta name="twitter:description" content="" /> -->
    <meta name="twitter:title" content="Organisers" />
    <meta name="twitter:site" content="@0rganizers" />
    <!-- TODO <meta name="twitter:image" content="" /> -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#040d21">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Hack monospace font -->
    <link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>
    <link rel="stylesheet" href="/assets/css/style.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">
    <link rel="stylesheet" href="/assets/css/highlight.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">
    <link rel="stylesheet" href="/assets/css/light.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">

    <!-- legitimize current Mastodon profile via link verification -->
    <link rel="me" href="https://infosec.exchange/@organizers" />


    <script type="text/javascript">
        function isLightThemeSelected() {
          return document.cookie.match(/theme=light/i) != null
        }

        function setThemeFromCookie() {
            var html = document.getElementsByTagName('html')[0]
            html.className = isLightThemeSelected() ? 'light-theme' : 'dark-theme'
            console.log('Loaded cookie: ' + document.cookie)
        }

        (function() {
          setThemeFromCookie()
        })();
    </script>

    <script type="text/javascript">
        function getFootnoteContent(linkId) {
            const fnId = linkId.replace(/^fnref/, 'fn');
            return document.getElementById(fnId).querySelector("p").innerHTML;
        }

        function addFootnote(element, content) {
            const footnote = document.createElement('div');
            footnote.classList.add('footnote-box');
            // Also add the footnote number
            footnote.innerHTML = `<sup>${element.innerText}</sup> ${content}`;
            footnote.querySelectorAll('a.reversefootnote').forEach((backlink) => {
                footnote.removeChild(backlink);
            });
            element.insertAdjacentElement('afterend', footnote);
            element.dataset.toggled = '1';
        }

        function removeFootnote(element) {
            element.parentElement.removeChild(element.nextSibling);
            element.dataset.toggled = '0';
        }


        window.addEventListener("load", function() {
            document.querySelectorAll("a.footnote").forEach((el) => {
                const sup = el.parentElement;
                el.addEventListener("click", (event) => {
                    const isOpen = Number.parseInt(sup.dataset.toggled || '0');
                    if (!isOpen) {
                        addFootnote(sup, getFootnoteContent(sup.id));
                    } else {
                        removeFootnote(sup);
                    }
                    event.preventDefault();
                });
            });
        });
    </script>

    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      "HTML-CSS": {
        fonts: ["Gyre-Pagella"],
        imageFont: null,
        undefinedFamily: "'Arial Unicode MS', cmbright"
      },
      tex2jax: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        processEscapes: true
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS_HTML"></script>
  </head>
  
  <body> 
    <header class="page-header-simple" role="banner">
      
      <div class="left-links"><a id="header-logo" href="/">Organi{s|z}ers</a></div>
      <div class="right-links">
        <a href="/writeups">Writeups</a>
        <a href="/achievements">Achievements</a>
      </div>
    </header>

    <main id="content" class="main-content" role="main">
      <h1 id="treebox">Treebox</h1>

<p><strong>Author</strong>: Robin_Jadoul</p>

<p><strong>Tags</strong>: pyjail</p>

<p><strong>Points</strong>: 50 (268 solves)</p>

<p><strong>Alternate URL</strong>: <a href="https://ur4ndom.dev/posts/2022-07-04-gctf-treebox/">https://ur4ndom.dev/posts/2022-07-04-gctf-treebox/</a></p>

<p><strong>Description</strong>:</p>

<blockquote>
  <p>I think I finally got Python sandboxing right.</p>
</blockquote>

<h2 id="on-the-topic-of-pyjails">On the topic of pyjails</h2>

<p>Python was one of the first programming languages I became acquainted with, and to this day remains one of – and probably even <em>the</em> – main language I go back to when I need to quickly write something, ranging from a proof of concept, to a hacky script that does some math when I’m too lazy, to the ever-recurring CTF solution scripts.<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>
As such, ever since I started playing CTFs and encountering pyjail challenges, I’ve thoroughly enjoyed the concept of these jails, the act of playing Houdini, and even occasionally creating some pyjail challenges myself.
For some examples of earlier pyjails I particularly enjoyed, you can for example refer to my writeups for <a href="https://ur4ndom.dev/posts/2022-02-08-dicectf-ti1337/">this recent challenge on DiceCTF</a> or <a href="https://ur4ndom.dev/posts/2020-06-29-0ctf-quals-pyaucalc/">the 0CTF/TCTF challenge</a> that to the best of my knowledge was the first to introduce the audit hook system as a jailing mechanism<sup id="fnref:audithookctf" role="doc-noteref"><a href="#fn:audithookctf" class="footnote" rel="footnote">2</a></sup>.</p>

<p>Through this fascination and repeated exposure to pyjail challenges, in combination with coincidentally opening up the challenge rather early on, I was able to snatch the first blood on it.
In a move that surprised myself too, I was able to have a turnaround time only <strong>2</strong> minutes between first looking at the challenge file, and obtaining the flag.</p>

<p>I was able to find several of the approaches and techniques presented further on by myself/independently, but in order to present a wider overview of the used attack surfaces, I also referenced the publicly posted exploits in the CTF discord.
Even for those approaches where I constructed my own viable payloads, I attempt to reference some messages posted in the #sandbox channel of the <a href="https://discord.gg/nt6JFkk3mu">public discord</a> after the conclusion of the CTF.</p>

<p>One interesting thing to notice for this challenge in particular, and presumably a reason for the high solve count, is that several of the pyjail escape methods listed on <a href="https://book.hacktricks.xyz/generic-methodologies-and-resources/python/bypass-python-sandboxes">the hacktricks page</a> apply directly to this challenge, so the situation is already well-documented.</p>

<h2 id="the-great-snake-constricted">The great snake, constricted</h2>

<p>Let’s first have a look at what the challenge allows us to do, or rather what it doesn’t allow us to do:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3 -u
#
# Flag is in a file called "flag" in cwd.
#
# Quote from Dockerfile:
#   FROM ubuntu:22.04
#   RUN apt-get update &amp;&amp; apt-get install -y python3
#
</span><span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">verify_secure</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ast</span><span class="p">.</span><span class="n">walk</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="n">match</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
      <span class="n">case</span> <span class="p">(</span><span class="n">ast</span><span class="p">.</span><span class="n">Import</span><span class="o">|</span><span class="n">ast</span><span class="p">.</span><span class="n">ImportFrom</span><span class="o">|</span><span class="n">ast</span><span class="p">.</span><span class="n">Call</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"ERROR: Banned statement </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
  <span class="k">return</span> <span class="bp">True</span>

<span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
<span class="n">dname</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dname</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"-- Please enter code (last line must contain only --END)"</span><span class="p">)</span>
<span class="n">source_code</span> <span class="o">=</span> <span class="s">""</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
  <span class="n">line</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="n">readline</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"--END"</span><span class="p">):</span>
    <span class="k">break</span>
  <span class="n">source_code</span> <span class="o">+=</span> <span class="n">line</span>

<span class="n">tree</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">source_code</span><span class="p">,</span> <span class="s">"input.py"</span><span class="p">,</span> <span class="s">'exec'</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">ast</span><span class="p">.</span><span class="n">PyCF_ONLY_AST</span><span class="p">)</span>
<span class="k">if</span> <span class="n">verify_secure</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>  <span class="c1"># Safe to execute!
</span>  <span class="k">print</span><span class="p">(</span><span class="s">"-- Executing safe code:"</span><span class="p">)</span>
  <span class="n">compiled</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">source_code</span><span class="p">,</span> <span class="s">"input.py"</span><span class="p">,</span> <span class="s">'exec'</span><span class="p">)</span>
  <span class="k">exec</span><span class="p">(</span><span class="n">compiled</span><span class="p">)</span>
</code></pre></div></div>

<p>Summarized: there is an <code class="language-plaintext highlighter-rouge">ast</code> based blacklist in place that prevents us from either calling functions<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">3</a></sup> or importing modules through the <code class="language-plaintext highlighter-rouge">import</code> statement.
As far as I’m aware, <code class="language-plaintext highlighter-rouge">ast</code> relies on the actual parser that the python interpreter itself uses, so we’re unlikely to encounter any parser differentials to abuse here.
On the upside, and something that’s certainly not a guarantee in this kind of challenge, we do have full access to all python builtins.
There are also no character-level blocks, so we <em>could</em> use parentheses in some context if we wanted; as long as they’re not used to call a function.</p>

<p>On the topic of <code class="language-plaintext highlighter-rouge">import</code> statements, it’s worth noting that, with the access to the python builtins that we have, being able to call functions is enough, since the <code class="language-plaintext highlighter-rouge">__import__</code> function could do everything we need from it.</p>

<p>Our end goal for this challenge would be an (arbitrary) file read of the <code class="language-plaintext highlighter-rouge">flag</code> file, but of course we won’t say no to getting full code execution if it happens to fit our needs.</p>

<p>My very first solution is similar to the <a href="https://polygl0ts.ch/writeups/2021/b01lers/pyjail_noparens/README.html">polygl0ts writeup</a> for the <a href="https://github.com/b01lers/b01lers-ctf-2021/tree/main/misc/noparensjail">noparensjail</a> challenge from b01lers CTF 2021.
Contrary to the intended solution presented by the people from b01lers, we can’t directly use <code class="language-plaintext highlighter-rouge">import</code>, so we need some other approach.
Luckily, the polygl0ts approach works, but is a bit more convoluted than what we really need.</p>

<p>To see why exactly, and to see the beauty of this exploit, we first make a quick detour through two <em>short</em> python expressions that can give us full code execution without further restrictions<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">4</a></sup> (either still in python, or directly in a shell).
Without a doubt, the shortest expression I know that achieves this is <code class="language-plaintext highlighter-rouge">help()</code>, which can spawn a shell through the <code class="language-plaintext highlighter-rouge">more</code> pager if a topic that takes up more than a page is requested at the interactive help prompt.
Unfortunately, that requires both a pager being present, and a tty, which isn’t the case for this challenge.
So instead, I went for the second convenient method I knew: <code class="language-plaintext highlighter-rouge">exec(input())</code>.
Since we arrive in a fresh execution context, with arbitrary code sent through stdin, the <code class="language-plaintext highlighter-rouge">ast</code> blacklist no longer applies to our new code, and we can do whatever we want from there.</p>

<p>So the full exploit code is something as simple as</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="k">exec</span>
<span class="o">@</span><span class="nb">input</span>
<span class="k">class</span> <span class="nc">X</span><span class="p">:</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p>and keeping in mind how <a href="https://docs.python.org/3/glossary.html#term-decorator">decorators</a> works, we can see that this code is equivalent to</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">X</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="n">X</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="k">exec</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</code></pre></div></div>

<p>which is essentially the same as our wanted <code class="language-plaintext highlighter-rouge">exec(input())</code> other than the fact that <code class="language-plaintext highlighter-rouge">input(X)</code> will also print a representation of the class <code class="language-plaintext highlighter-rouge">X</code> to stdout before reading.</p>

<p>Since decorators aren’t parsed as call expressions or statements, this passes the blacklist, and allows us to finally pass in an input such as <code class="language-plaintext highlighter-rouge">import os; os.system("sh")</code> to obtain a shell and display the flag.</p>

<p>See <a href="https://discord.com/channels/984515980766109716/992433413351018526/993233705927712899">this example</a> for a similar exploit template, but going through some different methods to establish code execution.</p>

<h2 id="alternative-approaches">Alternative approaches</h2>

<p>With my initial solution behind us now, let’s have a look at some of the other approaches, and general techniques that can also allow flag recovery on this challenge.
The general spirit behind all of these will obviously be to use something in the python ecosystem that ends up calling a function, without being an <em>explicit</em> function call.
The approaches I found or observed roughly fall into three categories:</p>

<ul>
  <li>Operator overloading</li>
  <li>Function overwriting</li>
  <li>Interpreter hooks</li>
</ul>

<p>These categories can of course overlap somewhat, or not exactly cover everything, but you get the idea :)</p>

<h3 id="operator-overloading-aka-xequalsstring-sucks">Operator overloading, aka <code class="language-plaintext highlighter-rouge">x.equals("string")</code> sucks</h3>

<p>In python, operator overloading in general works by writing custom functions on your class with special names.
These are also known as <em>dunder</em> methods, after how the names are all enclosed in <em>d</em>ouble <em>under</em>scores, such as the well-known <code class="language-plaintext highlighter-rouge">__init__</code> constructor.
So if we can overwrite functions such as <code class="language-plaintext highlighter-rouge">__getitem__</code> or <code class="language-plaintext highlighter-rouge">__add__</code> on a class, or if we can write our own classes with those methods, we can get function calls for example with</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">obj</span><span class="p">[</span><span class="n">argument</span><span class="p">]</span>
<span class="c1"># Or
</span><span class="n">obj</span> <span class="o">+</span> <span class="n">argument</span>
</code></pre></div></div>

<p>To overwrite these methods on existing classes/objects, we need to find something that’s implemented in plain python, as things implemented in C/in extension modules are read-only.
Some of the possible approaches are for example:</p>

<ul>
  <li>the <code class="language-plaintext highlighter-rouge">ast.AST</code> class and the available <code class="language-plaintext highlighter-rouge">tree</code> object (<a href="https://discord.com/channels/984515980766109716/992433413351018526/993310441516314739">example 1</a>, <a href="https://discord.com/channels/984515980766109716/992433413351018526/993241943284924546">example 2</a>)</li>
  <li>the <code class="language-plaintext highlighter-rouge">os.environ</code> object (<a href="https://discord.com/channels/984515980766109716/992433413351018526/993359479477391461">example</a>)</li>
</ul>

<h3 id="hippity-hoppity-this-attribute-is-now-my-property">Hippity, hoppity, this attribute is now my property</h3>

<p>Since some of these don’t take any arguments at all, we’ll also need some “one-shot” functions that we can leverage to get either an arbitrary file read, or more python control.</p>

<p>For arbitrary file read, one approach includes overwriting some of the innards of the <code class="language-plaintext highlighter-rouge">license()</code> builtin function.<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">5</a></sup>
More in particular, overwriting the “private”<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">6</a></sup> member variable that specifies from which files it reads license information.
Another approach calls the <code class="language-plaintext highlighter-rouge">breakpoint()</code> builtin, that by default points to <code class="language-plaintext highlighter-rouge">pdb.set_trace()</code>, which spawns a pdb debugger.
With a debugger, we can easily evaluate arbitrary python code again to obtain a system shell.</p>

<p>Another function that can be overwritten to get one-shot function call includes <code class="language-plaintext highlighter-rouge">sys.stdout.flush</code> which would get called upon interpreter exit, or <code class="language-plaintext highlighter-rouge">sys.stderr.flush</code> which can be triggered when an exception occurs.
Both the <code class="language-plaintext highlighter-rouge">os</code> and <code class="language-plaintext highlighter-rouge">sys</code> modules were already imported in the parent context, so we can access either <code class="language-plaintext highlighter-rouge">sys</code> directly, or pass through <code class="language-plaintext highlighter-rouge">os.sys</code>.</p>

<h3 id="everything-is-an-object-even-if-its-a-class">Everything is an object, even if it’s a class</h3>

<p>Next up, let’s explore a few ways to create objects, of course without calling the constructor explicitly.
The first approach towards this we can use relies on the concept of <a href="https://docs.python.org/3/reference/datamodel.html#metaclasses">metaclasses</a>.
In short, a class is itself also an object, and its type/class is known as a metaclass.
The standard metaclass for classes is <code class="language-plaintext highlighter-rouge">type</code>, whose own metaclass is, interestingly, <code class="language-plaintext highlighter-rouge">type</code>.
The key thing that metaclasses allow us to do is make an instance of a class, without calling the constructor directly, by creating a new class with the target class as metaclass.<sup id="fnref:6" role="doc-noteref"><a href="#fn:6" class="footnote" rel="footnote">7</a></sup>
Since this is all a bit confusing, perhaps, let’s show some example code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This will define the members on the "sub"class
</span><span class="k">class</span> <span class="nc">Metaclass</span><span class="p">:</span>
    <span class="n">__getitem__</span> <span class="o">=</span> <span class="k">exec</span> <span class="c1"># So Sub[string] will execute exec(string)
# Note: Metaclass.__class__ == type
</span>    
<span class="k">class</span> <span class="nc">Sub</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">Metaclass</span><span class="p">):</span> <span class="c1"># That's how we make Sub.__class__ == Metaclass
</span>    <span class="k">pass</span> <span class="c1"># Nothing special to do
</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Sub</span><span class="p">,</span> <span class="n">Metaclass</span><span class="p">)</span>
<span class="n">sub</span><span class="p">[</span><span class="s">'import os; os.system("sh")'</span><span class="p">]</span>
</code></pre></div></div>

<p>One other example takes this further by overloading the <code class="language-plaintext highlighter-rouge">__instancecheck__</code> dunder and triggering it through a <code class="language-plaintext highlighter-rouge">match</code> statement (<a href="https://discord.com/channels/984515980766109716/992433413351018526/993222030545666060">example</a>).</p>

<h3 id="exceptional-function-calls">Exceptional function calls</h3>

<p>Another approach to making instances of a class is also documented on <a href="https://book.hacktricks.xyz/generic-methodologies-and-resources/python/bypass-python-sandboxes#rce-declaring-exceptions">hacktricks</a>: throw and catch an exception.
Throwing an exception without arguments will automatically call its constructor.
Then we can either use of our previously-covered one-shot functions (<a href="https://docs.python.org/3/reference/datamodel.html#metaclasses">example</a>), or use the operator overloading as with the metaclasses above (what hacktricks does).</p>

<p>Writing a one-shot function taking three arguments to <code class="language-plaintext highlighter-rouge">sys.excepthook</code> could also allow for exploitation by throwing an (uncaught) exception.</p>

<p>And finally, looking at the <a href="https://github.com/google/google-ctf/blob/master/2022/sandbox-treebox/healthcheck/solution.py">reference solution</a>, we can see that there’s even some room to exploit OS/distro-specific functionality to combine with error handling and operator overloading to execute code.
In particular, here the interpreter will try to import an apt-specific module to potentially report an error in ubuntu-provided modules, but import will instead construct an object that will call an overloaded operator to execute code.
Without overwriting <code class="language-plaintext highlighter-rouge">__import__</code> and applying the previous exception-based object construction instead, we could also apply the same <code class="language-plaintext highlighter-rouge">__init__</code> to <code class="language-plaintext highlighter-rouge">__iadd__</code> chaining as demonstrated here.
More generally, defining <code class="language-plaintext highlighter-rouge">__init__</code> will allow for similar one-shot approaches taking an arbitrary number of arguments, such as we wished for above:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">X</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">+=</span> <span class="s">"os.system('sh')"</span>
    <span class="n">__iadd__</span> <span class="o">=</span> <span class="k">exec</span>
<span class="n">sys</span><span class="p">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">X</span>
<span class="mi">1</span><span class="o">/</span><span class="mi">0</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>This jail was leakier than a sieve, and it probably had the highest amount of sufficiently distinct potential solutions I’ve ever seen on a pyjail so far.
Together with some payloads that could be directly copy-pasted from previous writeups and hacktricks, this led to a high amount of solves.
The challenge itself was however still a lot of fun, and particularly interesting as a case-study of exploitation approaches that are allowed by a minimal-but-not-trivial AST-based blacklist,<sup id="fnref:7" role="doc-noteref"><a href="#fn:7" class="footnote" rel="footnote">8</a></sup> for which I would like to thank the author.</p>

<h3 id="addendum">Addendum</h3>

<p>While there were a lot of different exploits possible, I’m particularly happy with my initial one, for a few arbitrary reasons:</p>

<ul>
  <li>It got me a quick first blood</li>
  <li>It’s one of the few exploits that don’t need any parentheses at all</li>
  <li>When looking at it as a code golf challenge, it has the lowest amount of characters I’ve seen in any of the solutions posted on discord. This is even improved upon slightly be replacing the <code class="language-plaintext highlighter-rouge">pass</code> in the class body with simply the constant <code class="language-plaintext highlighter-rouge">0</code>.</li>
</ul>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>And of course, the existence of tools such as <a href="https://sagemath.org">sage</a> that plug into this ecosystem and that are indispensable for cryptographic exploration only serve to enhance my dependency on python. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:audithookctf" role="doc-endnote">
      <p>Since writing this, I’ve been informed that there were in fact earlier CTFs doing this that I was unaware of. For instance this <a href="https://redoste.xyz/2020/05/04/fr-write-up-fcsc-2020-why-not-a-sandbox/">French CTF</a> did it before, and potentially there’d be others too. <a href="#fnref:audithookctf" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>Or prevents us from calling <em>callables</em> in general, really. For instance constructing a class isn’t really calling a function, but it would get caught here too. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>As long as we still have access to the python builtins, otherwise we need to circumvent that, potentially in the second stage again too. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p>See <a href="https://book.hacktricks.xyz/generic-methodologies-and-resources/python/bypass-python-sandboxes#read-file-with-builtins-help">hacktricks</a> for a reference on exactly which member to write to. <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p>Heh, thanks python. <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:6" role="doc-endnote">
      <p>This is starting to feel like a “how many times can you use the word class in a sentence while still being understandable and correct”… <a href="#fnref:6" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:7" role="doc-endnote">
      <p>And obviously, that is exactly what this writeup aims to be :) <a href="#fnref:7" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>




<!--       <footer class="site-footer">
        <a href="https://twitter.com/0rganizers">Twitter</a> | <a id="changeTheme" class="btn-toggle">Dark-Mode</a>
      </footer> -->

      <div class="lever-meme">
        <div id="lever" class="lever-off"></div>
      </div>

      <div class="twitter">
        <a href="https://twitter.com/0rganizers"><img src="/assets/images/twitter.svg"></a>
      </div>

      <script>
        let leverCount = 0;
        let manic = false;

        function resetLever() {
            leverCount = 0;
            setTimeout(resetLever, 1750);
        }

        resetLever();

        document.getElementById('lever')
        .addEventListener('click', function (event) {
          if(leverCount > 10){
            manic = true;
            document.getElementById("lever").classList.add('lever-manic');
            document.getElementById("header-logo").classList.add('rainbow');
          }

          if(!manic){
            document.getElementById("lever").classList.toggle('lever-on');
            ++leverCount;
          }
        });


      </script>

      <script>
      function updateThemeToggleFooter() {
        let elem = document.querySelector('#lever');
        // elem.innerHTML = isLightThemeSelected() ? 'Dark Mode' : 'Light Mode'
      }

      (function() {
        updateThemeToggleFooter()
      })();

      function togglePageContentLightDark() {
          var html = document.getElementsByTagName('html')[0]
          var currentClass = html.className
          var newClass = html.className == 'dark-theme' ? 'light-theme' : 'dark-theme'
          html.className = newClass

          document.cookie = 'theme=' + (newClass == 'light-theme' ? 'light' : 'dark') + '; SameSite=Strict; path=/; expires=Fri, 31 Dec 9999 23:59:59 GMT'
          console.log('Cookies are now: ' + document.cookie)

          updateThemeToggleFooter()
      }

      const btn = document.querySelector("#lever");
      btn.addEventListener("click", function() {
        togglePageContentLightDark();
      });
      </script>
    </main>
  </body>
</html>
