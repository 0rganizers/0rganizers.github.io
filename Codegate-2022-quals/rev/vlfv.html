<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Very Long Flag Validator | Organisers</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Very Long Flag Validator" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="CTF Team" />
<meta property="og:description" content="CTF Team" />
<link rel="canonical" href="https://org.anize.rs/Codegate-2022-quals/rev/vlfv.html" />
<meta property="og:url" content="https://org.anize.rs/Codegate-2022-quals/rev/vlfv.html" />
<meta property="og:site_name" content="Organisers" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Very Long Flag Validator" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"CTF Team","headline":"Very Long Flag Validator","url":"https://org.anize.rs/Codegate-2022-quals/rev/vlfv.html"}</script>
<!-- End Jekyll SEO tag -->


    <meta property="og:image" content="https://org.anize.rs/assets/images/logo.png" />
    <meta name="twitter:card" content="summary" />
    <!-- TODO <meta name="twitter:description" content="" /> -->
    <meta name="twitter:title" content="Organisers" />
    <meta name="twitter:site" content="@0rganizers" />
    <!-- TODO <meta name="twitter:image" content="" /> -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#040d21">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Hack monospace font -->
    <link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>
    <link rel="stylesheet" href="/assets/css/style.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">
    <link rel="stylesheet" href="/assets/css/highlight.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">
    <link rel="stylesheet" href="/assets/css/light.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">

    <!-- legitimize current Mastodon profile via link verification -->
    <link rel="me" href="https://infosec.exchange/@organizers" />


    <script type="text/javascript">
        function isLightThemeSelected() {
          return document.cookie.match(/theme=light/i) != null
        }

        function setThemeFromCookie() {
            var html = document.getElementsByTagName('html')[0]
            html.className = isLightThemeSelected() ? 'light-theme' : 'dark-theme'
            console.log('Loaded cookie: ' + document.cookie)
        }

        (function() {
          setThemeFromCookie()
        })();
    </script>

    <script type="text/javascript">
        function getFootnoteContent(linkId) {
            const fnId = linkId.replace(/^fnref/, 'fn');
            return document.getElementById(fnId).querySelector("p").innerHTML;
        }

        function addFootnote(element, content) {
            const footnote = document.createElement('div');
            footnote.classList.add('footnote-box');
            // Also add the footnote number
            footnote.innerHTML = `<sup>${element.innerText}</sup> ${content}`;
            footnote.querySelectorAll('a.reversefootnote').forEach((backlink) => {
                footnote.removeChild(backlink);
            });
            element.insertAdjacentElement('afterend', footnote);
            element.dataset.toggled = '1';
        }

        function removeFootnote(element) {
            element.parentElement.removeChild(element.nextSibling);
            element.dataset.toggled = '0';
        }


        window.addEventListener("load", function() {
            document.querySelectorAll("a.footnote").forEach((el) => {
                const sup = el.parentElement;
                el.addEventListener("click", (event) => {
                    const isOpen = Number.parseInt(sup.dataset.toggled || '0');
                    if (!isOpen) {
                        addFootnote(sup, getFootnoteContent(sup.id));
                    } else {
                        removeFootnote(sup);
                    }
                    event.preventDefault();
                });
            });
        });
    </script>

    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      "HTML-CSS": {
        fonts: ["Gyre-Pagella"],
        imageFont: null,
        undefinedFamily: "'Arial Unicode MS', cmbright"
      },
      tex2jax: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        processEscapes: true
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS_HTML"></script>
  </head>
  
  <body> 
    <header class="page-header-simple" role="banner">
      
      <div class="left-links"><a id="header-logo" href="/">Organi{s|z}ers</a></div>
      <div class="right-links">
        <a href="/writeups">Writeups</a>
        <a href="/achievements">Achievements</a>
      </div>
    </header>

    <main id="content" class="main-content" role="main">
      <h1 id="very-long-flag-validator">Very Long Flag Validator</h1>

<p><strong>Author</strong>: TheBadGod</p>

<p><strong>Tags:</strong> rev</p>

<p><strong>Points:</strong> 1000 (2 solves)</p>

<p><strong>Description:</strong></p>

<blockquote>
  <p>Can you find the flag?</p>
</blockquote>

<h4 id="initial-reversing">Initial reversing</h4>

<p>After opening the binary in ida and adjusting the maximum size for functions
to actually get a nicer decompilation, I could identify some C++ functions
(it took some time to figure out that ida applied wrong lumina data and
it was actually just <code class="language-plaintext highlighter-rouge">vector::push_back</code> and not some Variadic thingy…</p>

<p>Anyway, after identifying that the main struct initialized in main is
64 vectors, 64 mutexes, 64 conditional variables and 64 chars and that
this struct is passed to 64 threads it was pretty clear that there will be
some inter-trhead communication.</p>

<p>So after looking at the first thread’s function for some time I realized
that it locks the lock with a certain index in the struct, then checks if
there’s something in the vector and if not, it waits using the conditional
variable with the same index as the lock. Then it pops a value from the vector,
(by getting the start pointer, dereffing and then popping the value using again
a C++ function which was a bit tricky to identify).</p>

<p>This value is then split into the lowest bit as well as the upper bits,
the upper bits are then compared with certain values (different in each
function), if the value matches, we store the lowest bit value in a local
variable (which was initialized to -1 to signify no value). There are always
three inputs which belong together, they are inputs into a full-adder, so we
have three inputs and two outputs, the carry was pushed into the vector
of the next function (in order they were started in / are stored in the binary)
the upper bits were set to one of the values that function was expecting.
The xor result of the three inputs was pushed into the vector of the same
function, again using one of the specified upper bits for this function.</p>

<h4 id="parsing-of-the-stuff-pain">Parsing of the stuff (pain)</h4>

<p>So this seems to be a dataflow machine, each function is a adding-station,
and it waits for certain tagged inputs to add them. There are eight functions
which belong together in the sense that the carry will go to the next function.
And of these pairs of eight functions there are eight, for a total of 64
functions. At this point I assumed that it doesn’t matter in which function
we are and that we just need to care about the tag of the inputs/outputs,
so I spent a long time to come up with a good way to parse all the station’s
inputs and outputs. In the end I came up with the following grep command:
<code class="language-plaintext highlighter-rouge">objdump --insn-width=100 -d -M intel main | grep -e ret -e cmp -e "[^x]or" -A 2</code>
which prints all the compares and since grep is smart is prints consecutive
matches as one block and then separates different blocks by a single line
of <code class="language-plaintext highlighter-rouge">--</code>. So by counting the amount of newlines between two <code class="language-plaintext highlighter-rouge">--</code> I was able
to determine if it was a block where we check for the two or three input
tag numbers. Then I just extracted the numbers from the compare instructions
to get the inputs. Finally if there was an or instruction I assumed that this
sets the upper bits of the output, there were some complications with this,
as the compiler is smart and emits an <code class="language-plaintext highlighter-rouge">or ah, 1</code> in cases where the tag
was 256, so I had to adjust that (and spend about an hour to find a bug
as one single function used dh instead of ah…).</p>

<p>After having parsed all of thses things it’s just a matter of putting
all the initial values and rules into z3 and letting it solve for the
correct input. This was easily done, as I could just copy the decompiled
code from main, fix up a few bits (again because of the ah). Then
I could easily parse that code to get the tags and corresponding values
(wether that was a constant or one of our input bits).</p>

<h4 id="final-script">Final script</h4>

<p>The final script to parse all the things and solver looks like this:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># objdump --insn-width=100 -d -M intel main | grep -e ret -e cmp -e "[^x]or" -A 2 &gt; cmps
</span><span class="n">x</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"cmps"</span><span class="p">).</span><span class="n">read</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"--"</span><span class="p">)</span>

<span class="c1">#the tags which symbolize the final value of a station
</span><span class="n">tgts</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0xec</span><span class="p">,</span><span class="mh">0x16d</span><span class="p">,</span><span class="mh">0x182</span><span class="p">,</span><span class="mh">0x185</span><span class="p">,</span><span class="mh">0x194</span><span class="p">,</span><span class="mh">0x197</span><span class="p">,</span><span class="mh">0x1a0</span><span class="p">,</span><span class="mh">0x1a3</span><span class="p">,</span><span class="mh">0x2ae</span><span class="p">,</span><span class="mh">0x2cf</span><span class="p">,</span><span class="mh">0x2d2</span><span class="p">,</span><span class="mh">0x2e4</span><span class="p">,</span><span class="mh">0x2f3</span><span class="p">,</span><span class="mh">0x2ff</span><span class="p">,</span><span class="mh">0x308</span><span class="p">,</span><span class="mh">0x30e</span><span class="p">,</span><span class="mh">0x4cd</span><span class="p">,</span><span class="mh">0x4d0</span><span class="p">,</span><span class="mh">0x4e5</span><span class="p">,</span><span class="mh">0x4e8</span><span class="p">,</span><span class="mh">0x4f7</span><span class="p">,</span><span class="mh">0x4fa</span><span class="p">,</span><span class="mh">0x4fd</span><span class="p">,</span><span class="mh">0x503</span><span class="p">,</span><span class="mh">0x57e</span><span class="p">,</span><span class="mh">0x6a4</span><span class="p">,</span><span class="mh">0x6b9</span><span class="p">,</span><span class="mh">0x6bc</span><span class="p">,</span><span class="mh">0x6cb</span><span class="p">,</span><span class="mh">0x6ce</span><span class="p">,</span><span class="mh">0x6d7</span><span class="p">,</span><span class="mh">0x6dd</span><span class="p">,</span><span class="mh">0x800</span><span class="p">,</span><span class="mh">0x84e</span><span class="p">,</span><span class="mh">0x863</span><span class="p">,</span><span class="mh">0x866</span><span class="p">,</span><span class="mh">0x869</span><span class="p">,</span><span class="mh">0x86c</span><span class="p">,</span><span class="mh">0x86f</span><span class="p">,</span><span class="mh">0x875</span><span class="p">,</span><span class="mh">0xa43</span><span class="p">,</span><span class="mh">0xa46</span><span class="p">,</span><span class="mh">0xa5b</span><span class="p">,</span><span class="mh">0xa6d</span><span class="p">,</span><span class="mh">0xa7c</span><span class="p">,</span><span class="mh">0xa7f</span><span class="p">,</span><span class="mh">0xa88</span><span class="p">,</span><span class="mh">0xa8e</span><span class="p">,</span><span class="mh">0xb6c</span><span class="p">,</span><span class="mh">0xbd5</span><span class="p">,</span><span class="mh">0xbff</span><span class="p">,</span><span class="mh">0xc02</span><span class="p">,</span><span class="mh">0xc11</span><span class="p">,</span><span class="mh">0xc1d</span><span class="p">,</span><span class="mh">0xc20</span><span class="p">,</span><span class="mh">0xc26</span><span class="p">,</span><span class="mh">0xce3</span><span class="p">,</span><span class="mh">0xdb8</span><span class="p">,</span><span class="mh">0xdcd</span><span class="p">,</span><span class="mh">0xdd0</span><span class="p">,</span><span class="mh">0xdd3</span><span class="p">,</span><span class="mh">0xdd6</span><span class="p">,</span><span class="mh">0xdd9</span><span class="p">,</span><span class="mh">0xddf</span><span class="p">]</span>
<span class="c1"># order the threads are started in
</span><span class="n">bitorder</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">46</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">63</span><span class="p">,</span><span class="mi">59</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">62</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">58</span><span class="p">,</span><span class="mi">47</span><span class="p">,</span><span class="mi">39</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">41</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">49</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">51</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">61</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">57</span><span class="p">,</span><span class="mi">48</span><span class="p">]</span>
<span class="c1"># the expected outputs, checked in main
</span><span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>

<span class="n">last_outs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">last_inputs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># init solver &amp; values for each tag
</span><span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>
<span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">Bool</span><span class="p">(</span><span class="sa">f</span><span class="s">"tag_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">"</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3554</span><span class="p">)]</span>

<span class="c1"># pushes from main
</span><span class="n">xx</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"pushes.c"</span><span class="p">).</span><span class="n">read</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Bool</span><span class="p">(</span><span class="sa">f</span><span class="s">"in[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">]"</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">64</span><span class="p">)]</span> <span class="c1"># our input, 64 bits (aka 8 bytes == 16 hex chars)
</span><span class="n">consts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">64</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xx</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="s">""</span><span class="p">:</span> <span class="k">continue</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>   
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"["</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">"]"</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">s</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">==</span> <span class="n">bit</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">"|"</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"|"</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">";"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">tag</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tag</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">input_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"["</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">"]"</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">bit</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">input_idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"="</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">strip</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
            <span class="n">consts</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">bit</span>

<span class="c1"># the constant values
#print([1 if x else 0 for x in consts])
</span>
<span class="c1"># the adding stations...
</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
    <span class="k">if</span> <span class="s">"ret"</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">64</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">fl</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">"or"</span> <span class="ow">in</span> <span class="n">fl</span> <span class="ow">and</span> <span class="s">"0x"</span> <span class="ow">in</span> <span class="n">fl</span><span class="p">:</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fl</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">","</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">strip</span><span class="p">(),</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xx</span> <span class="o">&gt;</span> <span class="mh">0x10000</span><span class="p">:</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
        <span class="k">if</span> <span class="s">"ah"</span> <span class="ow">in</span> <span class="n">fl</span> <span class="ow">or</span> <span class="s">"dh"</span> <span class="ow">in</span> <span class="n">fl</span><span class="p">:</span><span class="c1"># man fuck dh
</span>            <span class="n">xx</span><span class="o">&lt;&lt;=</span><span class="mi">8</span>

        <span class="k">assert</span><span class="p">(</span><span class="n">xx</span><span class="o">&amp;</span><span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">last_outs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">xx</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">63</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_outs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_outs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1">#print(last_inputs, "=&gt;", last_outs)
</span>            <span class="n">xored_tgt</span> <span class="o">=</span> <span class="n">last_outs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_inputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">s</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Xor</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="n">last_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">tags</span><span class="p">[</span><span class="n">last_inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">==</span> <span class="n">tags</span><span class="p">[</span><span class="n">xored_tgt</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Man fuck z3, why does it allow Xor(a,b,c) with three inputs but doesn't fucking work
</span>                <span class="c1"># This could've been solved like 3 hours earlier but because of this fucking
</span>                <span class="c1"># z3 thingy they were lost, rip
</span>                <span class="n">s</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Xor</span><span class="p">(</span><span class="n">Xor</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="n">last_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">tags</span><span class="p">[</span><span class="n">last_inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span> <span class="n">tags</span><span class="p">[</span><span class="n">last_inputs</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span> <span class="o">==</span> <span class="n">tags</span><span class="p">[</span><span class="n">xored_tgt</span><span class="p">])</span>
        
            <span class="k">if</span> <span class="n">xored_tgt</span> <span class="ow">in</span> <span class="n">tgts</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"Target found: "</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">last_inputs</span><span class="p">,</span> <span class="n">last_outs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_outs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ovf_tgt</span> <span class="o">=</span> <span class="n">last_outs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">#print(idx, last_inputs, last_outs)
</span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_inputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">s</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">And</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="n">last_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">tags</span><span class="p">[</span><span class="n">last_inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">==</span> <span class="n">tags</span><span class="p">[</span><span class="n">ovf_tgt</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="n">last_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">tags</span><span class="p">[</span><span class="n">last_inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">tags</span><span class="p">[</span><span class="n">last_inputs</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                <span class="n">s</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Or</span><span class="p">(</span><span class="n">And</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">And</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">c</span><span class="p">),</span> <span class="n">And</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">))</span> <span class="o">==</span> <span class="n">tags</span><span class="p">[</span><span class="n">ovf_tgt</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">i</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">last_inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last_outs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">i</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">):</span>
            <span class="k">if</span> <span class="s">"cmp"</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">last_inputs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">","</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">last_inputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">last_inputs</span><span class="p">))</span>
        <span class="c1">#print(idx, last_inputs)
</span>
<span class="c1"># extract the resulting bits
</span><span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">tags</span><span class="p">[</span><span class="n">tgts</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">64</span><span class="p">)]</span>

<span class="c1"># add the conditions
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">64</span><span class="p">):</span>
    <span class="n">s</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="o">==</span><span class="n">expected</span><span class="p">[</span><span class="n">bitorder</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>

<span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">check</span><span class="p">()</span> <span class="o">==</span> <span class="n">sat</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">model</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s">""</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="s">"1"</span> <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s">"0"</span>
    <span class="k">print</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))[:</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"oof"</span><span class="p">)</span>
</code></pre></div></div>




<!--       <footer class="site-footer">
        <a href="https://twitter.com/0rganizers">Twitter</a> | <a id="changeTheme" class="btn-toggle">Dark-Mode</a>
      </footer> -->

      <div class="lever-meme">
        <div id="lever" class="lever-off"></div>
      </div>

      <div class="twitter">
        <a href="https://twitter.com/0rganizers"><img src="/assets/images/twitter.svg"></a>
      </div>

      <script>
        let leverCount = 0;
        let manic = false;

        function resetLever() {
            leverCount = 0;
            setTimeout(resetLever, 1750);
        }

        resetLever();

        document.getElementById('lever')
        .addEventListener('click', function (event) {
          if(leverCount > 10){
            manic = true;
            document.getElementById("lever").classList.add('lever-manic');
            document.getElementById("header-logo").classList.add('rainbow');
          }

          if(!manic){
            document.getElementById("lever").classList.toggle('lever-on');
            ++leverCount;
          }
        });


      </script>

      <script>
      function updateThemeToggleFooter() {
        let elem = document.querySelector('#lever');
        // elem.innerHTML = isLightThemeSelected() ? 'Dark Mode' : 'Light Mode'
      }

      (function() {
        updateThemeToggleFooter()
      })();

      function togglePageContentLightDark() {
          var html = document.getElementsByTagName('html')[0]
          var currentClass = html.className
          var newClass = html.className == 'dark-theme' ? 'light-theme' : 'dark-theme'
          html.className = newClass

          document.cookie = 'theme=' + (newClass == 'light-theme' ? 'light' : 'dark') + '; SameSite=Strict; path=/; expires=Fri, 31 Dec 9999 23:59:59 GMT'
          console.log('Cookies are now: ' + document.cookie)

          updateThemeToggleFooter()
      }

      const btn = document.querySelector("#lever");
      btn.addEventListener("click", function() {
        togglePageContentLightDark();
      });
      </script>
    </main>
  </body>
</html>
