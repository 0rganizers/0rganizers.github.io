<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Pow-Pow | Organisers</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Pow-Pow" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="CTF Team" />
<meta property="og:description" content="CTF Team" />
<link rel="canonical" href="https://org.anize.rs/dicectf-2022/crypto/powpow.html" />
<meta property="og:url" content="https://org.anize.rs/dicectf-2022/crypto/powpow.html" />
<meta property="og:site_name" content="Organisers" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Pow-Pow" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"CTF Team","headline":"Pow-Pow","url":"https://org.anize.rs/dicectf-2022/crypto/powpow.html"}</script>
<!-- End Jekyll SEO tag -->


    <meta property="og:image" content="https://org.anize.rs/assets/images/logo.png" />
    <meta name="twitter:card" content="summary" />
    <!-- TODO <meta name="twitter:description" content="" /> -->
    <meta name="twitter:title" content="Organisers" />
    <meta name="twitter:site" content="@0rganizers" />
    <!-- TODO <meta name="twitter:image" content="" /> -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#040d21">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Hack monospace font -->
    <link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>
    <link rel="stylesheet" href="/assets/css/style.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">
    <link rel="stylesheet" href="/assets/css/highlight.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">
    <link rel="stylesheet" href="/assets/css/light.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">

    <!-- legitimize current Mastodon profile via link verification -->
    <link rel="me" href="https://infosec.exchange/@organizers" />


    <script type="text/javascript">
        function isLightThemeSelected() {
          return document.cookie.match(/theme=light/i) != null
        }

        function setThemeFromCookie() {
            var html = document.getElementsByTagName('html')[0]
            html.className = isLightThemeSelected() ? 'light-theme' : 'dark-theme'
            console.log('Loaded cookie: ' + document.cookie)
        }

        (function() {
          setThemeFromCookie()
        })();
    </script>

    <script type="text/javascript">
        function getFootnoteContent(linkId) {
            const fnId = linkId.replace(/^fnref/, 'fn');
            return document.getElementById(fnId).querySelector("p").innerHTML;
        }

        function addFootnote(element, content) {
            const footnote = document.createElement('div');
            footnote.classList.add('footnote-box');
            // Also add the footnote number
            footnote.innerHTML = `<sup>${element.innerText}</sup> ${content}`;
            footnote.querySelectorAll('a.reversefootnote').forEach((backlink) => {
                footnote.removeChild(backlink);
            });
            element.insertAdjacentElement('afterend', footnote);
            element.dataset.toggled = '1';
        }

        function removeFootnote(element) {
            element.parentElement.removeChild(element.nextSibling);
            element.dataset.toggled = '0';
        }


        window.addEventListener("load", function() {
            document.querySelectorAll("a.footnote").forEach((el) => {
                const sup = el.parentElement;
                el.addEventListener("click", (event) => {
                    const isOpen = Number.parseInt(sup.dataset.toggled || '0');
                    if (!isOpen) {
                        addFootnote(sup, getFootnoteContent(sup.id));
                    } else {
                        removeFootnote(sup);
                    }
                    event.preventDefault();
                });
            });
        });
    </script>

    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      "HTML-CSS": {
        fonts: ["Gyre-Pagella"],
        imageFont: null,
        undefinedFamily: "'Arial Unicode MS', cmbright"
      },
      tex2jax: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        processEscapes: true
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS_HTML"></script>
  </head>
  
  <body> 
    <header class="page-header-simple" role="banner">
      
      <div class="left-links"><a id="header-logo" href="/">Organi{s|z}ers</a></div>
      <div class="right-links">
        <a href="/writeups">Writeups</a>
        <a href="/achievements">Achievements</a>
      </div>
    </header>

    <main id="content" class="main-content" role="main">
      <h1 id="pow-pow">Pow-Pow</h1>

<p><strong>Authors:</strong> Jack</p>

<p><strong>Tags:</strong> crypto, VDF</p>

<p><strong>Points:</strong> 299 (13 solves)</p>

<p><strong>Challenge Author:</strong> defund</p>

<p><strong>Description:</strong></p>

<blockquote>
  <p>It’s a free flag, all you have to do is wait! Verifiably.</p>

  <p><code class="language-plaintext highlighter-rouge">nc mc.ax 31337</code></p>
</blockquote>

<h2 id="challenge">Challenge</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/local/bin/python
</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">shake_128</span>

<span class="c1"># from Crypto.Util.number import getPrime
# p = getPrime(1024)
# q = getPrime(1024)
# n = p*q
</span><span class="n">n</span> <span class="o">=</span> <span class="mi">20074101780713298951367849314432888633773623313581383958340657712957528608477224442447399304097982275265964617977606201420081032385652568115725040380313222774171370125703969133604447919703501504195888334206768326954381888791131225892711285554500110819805341162853758749175453772245517325336595415720377917329666450107985559621304660076416581922028713790707525012913070125689846995284918584915707916379799155552809425539923382805068274756229445925422423454529793137902298882217687068140134176878260114155151600296131482555007946797335161587991634886136340126626884686247248183040026945030563390945544619566286476584591</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span>

<span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">n</span>

<span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="s">'big'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">H</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">shake_128</span><span class="p">(</span><span class="n">encode</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">+</span> <span class="n">encode</span><span class="p">(</span><span class="n">h</span><span class="p">)).</span><span class="n">digest</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="s">'big'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">prove</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">g</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">H</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="n">pi</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">h</span><span class="p">,</span> <span class="n">pi</span>

<span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">pi</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">is_valid</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">is_valid</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">is_valid</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">g</span> <span class="o">!=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">H</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">h</span> <span class="o">==</span> <span class="nb">pow</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">g</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s">'g: '</span><span class="p">))</span>
    <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s">'h: '</span><span class="p">))</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s">'pi: '</span><span class="p">))</span>
    <span class="n">verify</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">pi</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'flag.txt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">strip</span><span class="p">())</span>
</code></pre></div></div>

<h2 id="solution">Solution</h2>

<p>The challenge presents us with a verifiable delay function (VDF), which (if correctly implemented) requires us to compute</p>

\[h \equiv g^{2^T} \pmod n.\]

<p>This requires us to perform $T = 2^{64}$ squares of $g \pmod n$, which is totally infeasible for a weekend CTF! If we could factor $n$, we could first compute $a \equiv 2^T \pmod{\phi(n)}$, but as the challenge is set up, it’s obvious we can’t factor the 2048 bit modulus.</p>

<p>Another option would be to pick a generator $g$ of low order, for the RSA group $\mathcal{G} = (\mathbb{Z}/n\mathbb{Z})^*$, two easy options are $g=1$ or $g=-1$. However, looking at <code class="language-plaintext highlighter-rouge">verify(g,h,pi)</code>, we see that these elements are explicitly excluded from being considered</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">n</span>

<span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">pi</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">is_valid</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">is_valid</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">is_valid</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">g</span> <span class="o">!=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">H</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">h</span> <span class="o">==</span> <span class="nb">pow</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
</code></pre></div></div>

<p>First <code class="language-plaintext highlighter-rouge">is_valid(x)</code> ensures that $g,h,\pi \in \mathcal{G}$ and then the additional check <code class="language-plaintext highlighter-rouge">assert g != 1 and g != n - 1</code> ensures that $g$ has unknown order.</p>

<p>So if we can’t run <code class="language-plaintext highlighter-rouge">prove(g)</code> in a reasonable amount of time, and we can’t cheat the VDF by factoring, or selecting an element of known order, then there must be something within <code class="language-plaintext highlighter-rouge">verify</code> we can cheat.</p>

<p>First, let’s look at what appears in <code class="language-plaintext highlighter-rouge">verify(g,h,pi)</code> and what we have control over.</p>

<p>We choose as input any $g,h,\pi \in \mathcal{G}$ and from $g,h$ <code class="language-plaintext highlighter-rouge">shake128</code> is used as a pseudorandom function to generate $m$. Finally, from $m$ we find $r \equiv 2^T \pmod m$.</p>

<p>To pass the test in verify, naively we need to send integers from the output of <code class="language-plaintext highlighter-rouge">h, pi = prove(g)</code> such that the following congruence holds:</p>

\[h \equiv g^r \cdot \pi^m \pmod n.\]

<p>Although this congruence assumes the input $(g,h,\pi)$ have the relationship established by <code class="language-plaintext highlighter-rouge">prove(g)</code>, what if we instead view this as a general congruence? Let’s try by assuming all variables can be expressed as a power of a generator $b$ and attempt to forget about <code class="language-plaintext highlighter-rouge">prove(g)</code> altogether! For our implementation, we make the choice $b = 2$, but this is arbitary.</p>

\[g \equiv b^M \pmod n, \quad h \equiv b^A \pmod n, \quad \pi \equiv b^B \pmod n.\]

<p>From this point of view, we need to try and find integers $(M,A,B)$ such that</p>

\[b^A \equiv b^{rM} \cdot b^{mB} \pmod n \Leftarrow A = rM + mB\]

<p>The integers $(m,r)$ are generated from</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">H</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">shake_128</span><span class="p">(</span><span class="n">encode</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">+</span> <span class="n">encode</span><span class="p">(</span><span class="n">h</span><span class="p">)).</span><span class="n">digest</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="s">'big'</span><span class="p">)</span>

<span class="c1"># We can pick these
</span><span class="n">M</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="err">?</span><span class="p">,</span> <span class="err">?</span><span class="p">,</span> <span class="err">?</span>
<span class="n">g</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">h</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">pi</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># Effectively random
</span><span class="n">m</span> <span class="o">=</span> <span class="n">H</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
</code></pre></div></div>

<p>and we can effectively treat these integers as totally random. More importantly, the values are unknown until we make a choice for both $g,h$ (and therefore $M,A$).</p>

<p>Our first simplification will be $A = 0 \Rightarrow h = 1$, which simplifies our equation and is a valid input for $h$. Now we need to pick $(M,B)$ such that</p>

\[0 = rM + mB,\]

<p>where we remember that the values of $(r,m)$ are only known after selecting $M$, but $B$ can be set afterwards. It then makes sense to rearrange the above equation into the form:</p>

\[B = -\frac{rM}{m}\]

<p>To find an integer solution $B$, we then need to find some $rM$ which is divisible by a random integer $m$.</p>

<p>The VDF function which appears in the challenge is based off work by <a href="https://eprint.iacr.org/2018/623">Wesolowski</a>, reviewed in a paper by <a href="https://eprint.iacr.org/2018/712.pdf">Boneh, Bünz and Fisch</a>. There is a key difference though between the paper and the challenge. In Wesolowski’s work, $m$ is prime, and finding a $M$ divisible by some large, random prime is computationally hard. The challenge becomes solvable because $m$ is totally random and so can be composite.</p>

<p>To find an integer $M \equiv 0 \pmod m$, the best chance we have is to use some very smooth integer, such as $M = n!$, or $M = \prod_i^n p_i$ as the product of the first $n$ primes. In the challenge author’s <a href="https://priv.pub/posts/dicectf-2022">write-up</a>, they pick</p>

\[M = 256! \prod_i^n p_i,\]

<p>where they consider all primes $p_i &lt; 10^{20}$. Including $256!$ allows for repeated small factors in $m$. In our solution, we find it is enough to simply take the product of all primes below $10^6$.</p>

<p>To then solve the congruence, we first generate a very smooth integer $M$ and set $g \equiv b^M \pmod n$. From this, we compute $m = H(g,1)$. If $M \equiv 0 \pmod m$ we break the loop, compute $r$ from $m$, then $B(M,r,m)$. Finally setting $\pi \equiv b^B \pmod n$ for our solution $(g,h,\pi)$. If the congruence doesn’t hold, we square $g \equiv g^2 \pmod n$ and double $M = 2M$ for bookkeeping, and try again.</p>

<p>Sending our specially crafted $(g,h,\pi) = (g,1,\pi)$ to the server, we get the flag.</p>

<h2 id="implementation">Implementation</h2>

<p><strong>Note:</strong> We use <code class="language-plaintext highlighter-rouge">gmpy2</code> to speed up all the modular maths we need to do, but you can do this using python’s <code class="language-plaintext highlighter-rouge">int</code> type and solve in a reasonable amount of time.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">gmpy2</span> <span class="kn">import</span> <span class="n">mpz</span><span class="p">,</span> <span class="n">is_prime</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">shake_128</span>

<span class="c1">##################
# Challenge Data #
##################
</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">mpz</span><span class="p">(</span><span class="mi">20074101780713298951367849314432888633773623313581383958340657712957528608477224442447399304097982275265964617977606201420081032385652568115725040380313222774171370125703969133604447919703501504195888334206768326954381888791131225892711285554500110819805341162853758749175453772245517325336595415720377917329666450107985559621304660076416581922028713790707525012913070125689846995284918584915707916379799155552809425539923382805068274756229445925422423454529793137902298882217687068140134176878260114155151600296131482555007946797335161587991634886136340126626884686247248183040026945030563390945544619566286476584591</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">mpz</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">64</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">n</span>

<span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="s">'big'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="s">'big'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">H</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">shake_128</span><span class="p">(</span><span class="n">encode</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">+</span> <span class="n">encode</span><span class="p">(</span><span class="n">h</span><span class="p">)).</span><span class="n">digest</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="s">'big'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">pi</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">is_valid</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">is_valid</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">is_valid</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">g</span> <span class="o">!=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">H</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="c1"># change assert to return bool for testing
</span>    <span class="k">return</span> <span class="n">h</span> <span class="o">==</span> <span class="nb">pow</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>

<span class="c1">##################
#    Solution    #
##################
</span>
<span class="k">def</span> <span class="nf">gen_smooth</span><span class="p">(</span><span class="n">upper_bound</span><span class="p">):</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">mpz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_prime</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">M</span> <span class="o">*=</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="k">def</span> <span class="nf">gen_solution</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="c1"># We pick a generator b = 2
</span>    <span class="n">g</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">mpz</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">M</span> <span class="o">%</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
            <span class="n">B</span> <span class="o">=</span> <span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="n">M</span> <span class="o">//</span> <span class="n">m</span>
            <span class="n">pi</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">g</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> 
        <span class="n">M</span> <span class="o">=</span> <span class="n">M</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
        <span class="n">g</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Generating smooth value M"</span><span class="p">)</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">gen_smooth</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Searching for valid m"</span><span class="p">)</span>
<span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">pi</span> <span class="o">=</span> <span class="n">gen_solution</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">verify</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">pi</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"g  = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"h  = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"pi = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="flag">Flag</h2>

<p><code class="language-plaintext highlighter-rouge">dice{the_m1n1gun_4nd_f1shb0nes_the_r0ck3t_launch3r}</code></p>




<!--       <footer class="site-footer">
        <a href="https://twitter.com/0rganizers">Twitter</a> | <a id="changeTheme" class="btn-toggle">Dark-Mode</a>
      </footer> -->

      <div class="lever-meme">
        <div id="lever" class="lever-off"></div>
      </div>

      <div class="twitter">
        <a href="https://twitter.com/0rganizers"><img src="/assets/images/twitter.svg"></a>
      </div>

      <script>
        let leverCount = 0;
        let manic = false;

        function resetLever() {
            leverCount = 0;
            setTimeout(resetLever, 1750);
        }

        resetLever();

        document.getElementById('lever')
        .addEventListener('click', function (event) {
          if(leverCount > 10){
            manic = true;
            document.getElementById("lever").classList.add('lever-manic');
            document.getElementById("header-logo").classList.add('rainbow');
          }

          if(!manic){
            document.getElementById("lever").classList.toggle('lever-on');
            ++leverCount;
          }
        });


      </script>

      <script>
      function updateThemeToggleFooter() {
        let elem = document.querySelector('#lever');
        // elem.innerHTML = isLightThemeSelected() ? 'Dark Mode' : 'Light Mode'
      }

      (function() {
        updateThemeToggleFooter()
      })();

      function togglePageContentLightDark() {
          var html = document.getElementsByTagName('html')[0]
          var currentClass = html.className
          var newClass = html.className == 'dark-theme' ? 'light-theme' : 'dark-theme'
          html.className = newClass

          document.cookie = 'theme=' + (newClass == 'light-theme' ? 'light' : 'dark') + '; SameSite=Strict; path=/; expires=Fri, 31 Dec 9999 23:59:59 GMT'
          console.log('Cookies are now: ' + document.cookie)

          updateThemeToggleFooter()
      }

      const btn = document.querySelector("#lever");
      btn.addEventListener("click", function() {
        togglePageContentLightDark();
      });
      </script>
    </main>
  </body>
</html>
